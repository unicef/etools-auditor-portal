name: Lint and Build Docker Image

on:
  push:
    branches:
      - '**'
    tags:
      - '*'
  pull_request:

concurrency:
  group: etools-ap-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22.21.1'
  DOCKER_IMAGE: unicef/etools-ap

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  build_and_push:
    name: Build and Push Docker Image
    needs: lint
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      (startsWith(github.ref, 'refs/tags/') ||
       github.ref_name == 'master' ||
       github.ref_name == 'staging' ||
       github.ref_name == 'develop' ||
       github.ref_name == 'face-linking')

    outputs:
      image_tag: ${{ steps.branch.outputs.branch_name }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Sanitize branch name
        id: branch
        run: |
          SAFE_BRANCH=$(echo "$GITHUB_REF_NAME" | tr '/' '-' | tr -cd 'a-zA-Z0-9._-')
          echo "branch_name=$SAFE_BRANCH" >> "$GITHUB_OUTPUT"

      - name: Export revision metadata
        run: |
          sed -i "0,/revNo/s//${GITHUB_SHA}/" index.html
          sed -i "0,/revNo/s//${GITHUB_SHA}/" version.json
          sed -i "0,/bDate/s//$(date -u +%F_%T)/" index.html
          sed -i "0,/bDate/s//$(date -u +%F_%T)/" version.json

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USER }}
          password: ${{ secrets.DOCKER_PASS }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: |
            ${{ env.DOCKER_IMAGE }}:${{ steps.branch.outputs.branch_name }}
            ${{ env.DOCKER_IMAGE }}:${{ github.sha }}
            ${{ startsWith(github.ref, 'refs/tags/') && format('{0}:{1}', env.DOCKER_IMAGE, github.ref_name) || '' }}

  deploy_develop:
    name: Deploy to Develop (Rancher)
    needs: build_and_push
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' &&
      github.ref_name == 'develop' &&
      needs.build_and_push.outputs.image_tag != ''

    steps:
      - name: Install kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.29.3

      - name: Configure kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG_B64 }}" | base64 -d > ~/.kube/config
          chmod 600 ~/.kube/config
          kubectl config use-context rke-cluster-devtst

      - name: Deploy to Kubernetes
        run: |
          kubectl -n etools-dev \
            set image deployment/fam-dev \
            fam-dev=${{ env.DOCKER_IMAGE }}:${{ needs.build_and_push.outputs.image_tag }}

          kubectl rollout restart deployment/fam-dev -n etools-dev
          kubectl rollout status deployment/fam-dev -n etools-dev
