trigger: none
pr: none

parameters:
  - name: imageTag
    displayName: Docker image tag to deploy
    type: string
    default: staging

variables:
  DOCKER_IMAGE: unicef/etools-ap

stages:
- stage: DeployDemo
  displayName: Deploy to Demo (Rancher)

  variables:
    - group: rke-cluster-etstgtrn

  jobs:
  - deployment: Deploy
    displayName: Deploy to demo
    environment: demo
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:
            - script: |
                echo "Checking image existence:"
                echo "$(DOCKER_IMAGE):${{ parameters.imageTag }}"
                docker manifest inspect \
                  $(DOCKER_IMAGE):${{ parameters.imageTag }} \
                  > /dev/null
              displayName: Validate image exists

            - task: KubectlInstaller@0
              displayName: Install kubectl
              inputs:
                kubectlVersion: 'v1.16.2'

            - script: |
                mkdir -p ~/.kube
                echo "$(KUBECONFIG_B64)" | base64 -d > ~/.kube/config
                chmod 600 ~/.kube/config
                kubectl config use-context rke-cluster-etstgtrn
              displayName: Configure kubeconfig

            - script: |
                kubectl -n etools-demo \
                  set image deployment/fam-demo \
                  fam-demo=$(DOCKER_IMAGE):${{ parameters.imageTag }}
              displayName: Deploy application

            - script: |
                kubectl rollout status deployment/fam-demo \
                  -n etools-demo \
                  --timeout=300s
              displayName: Wait for pods to start
