trigger:
  branches:
    include:
      - '*'

pr:
  branches:
    include:
      - '*'

variables:
  NODE_VERSION: '22.21.1'
  DOCKER_IMAGE: 'unicef/etools-ap'

stages:
  - stage: Lint
    displayName: Lint
    jobs:
      - job: Lint
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
            fetchDepth: 1

          - task: NodeTool@0
            displayName: 'Use Node.js $(NODE_VERSION)'
            inputs:
              versionSpec: '$(NODE_VERSION)'

          - script: npm ci
            displayName: Install dependencies

          - script: npm run lint
            displayName: Run ESLint

  - stage: BuildAndPush
    displayName: Build and Push Docker Image
    dependsOn: Lint
    condition: |
      and(
        succeeded(),
        or(
          startsWith(variables['Build.SourceBranch'], 'refs/tags/'),
          eq(variables['Build.SourceBranch'], 'refs/heads/master'),
          eq(variables['Build.SourceBranch'], 'refs/heads/staging'),
          eq(variables['Build.SourceBranch'], 'refs/heads/azure-environments'),
          eq(variables['Build.SourceBranch'], 'refs/heads/develop')
        )
      )

    jobs:
      - job: Docker
        pool:
          vmImage: ubuntu-latest
        steps:
          - checkout: self
            fetchDepth: 0

          - script: |
              SAFE_BRANCH=$(echo "$(Build.SourceBranchName)" \
                | tr '/' '-' \
                | tr -cd 'a-zA-Z0-9._-')
              echo "##vso[task.setvariable variable=SAFE_BRANCH;isOutput=true]$SAFE_BRANCH"
            name: sanitize
            displayName: Sanitize branch name

          - script: |
              sed -i "0,/revNo/s//$(Build.SourceVersion)/" index.html
              sed -i "0,/revNo/s//$(Build.SourceVersion)/" version.json
              sed -i "0,/bDate/s//$(date -u +%F_%T)/" index.html
              sed -i "0,/bDate/s//$(date -u +%F_%T)/" version.json
            displayName: Inject build metadata

          - task: Docker@2
            displayName: Build and push image
            inputs:
              command: buildAndPush
              repository: $(DOCKER_IMAGE)
              dockerfile: Dockerfile
              containerRegistry: dockerhub
              tags: |
                $(sanitize.SAFE_BRANCH)
                $(Build.SourceVersion)

  - stage: DeployDevelop
    displayName: Deploy to Develop (Rancher)
    dependsOn: BuildAndPush
    condition: |
      and(
        succeeded(),
        eq(variables['Build.SourceBranch'], 'refs/heads/azure-environments')
      )

    variables:
      - group: rke-cluster-devtst

    jobs:
    - deployment: Deploy
      displayName: Deploy to develop
      environment: dev
      pool:
        vmImage: ubuntu-latest
      strategy:
        runOnce:
          deploy:
            steps:
              - task: KubectlInstaller@0
                displayName: Install kubectl
                inputs:
                  kubectlVersion: 'v1.16.2'

              - script: |
                  mkdir -p ~/.kube
                  echo "$(KUBECONFIG_B64)" | base64 -d > ~/.kube/config
                  chmod 600 ~/.kube/config
                  kubectl config use-context rke-cluster-devtst
                displayName: Configure kubeconfig

              - script: |
                  kubectl -n etools-dev \
                    set image deployment/fam-dev \
                    fam-dev=unicef/etools-ap:$(Build.SourceVersion)
                displayName: Deploy application

              - script: |
                  kubectl rollout status deployment/fam-dev \
                    -n etools-dev \
                    --timeout=300s
                displayName: Wait for pods to start

  - stage: DeployStaging
    displayName: Deploy to Staging (Rancher)
    dependsOn: BuildAndPush
    condition: |
      and(
        succeeded(),
        eq(variables['Build.SourceBranch'], 'refs/heads/azure-environments')
      )

    variables:
      - group: rke-cluster-etstgtrn

    jobs:
    - deployment: Deploy
      displayName: Deploy to staging
      environment: staging
      pool:
        vmImage: ubuntu-latest
      strategy:
        runOnce:
          deploy:
            steps:
              - task: KubectlInstaller@0
                displayName: Install kubectl
                inputs:
                  kubectlVersion: 'v1.16.2'

              - script: |
                  mkdir -p ~/.kube
                  echo "$(KUBECONFIG_B64)" | base64 -d > ~/.kube/config
                  chmod 600 ~/.kube/config
                  kubectl config use-context rke-cluster-etstgtrn
                displayName: Configure kubeconfig

              # - script: |
              #     kubectl -n etools-staging \
              #       set image deployment/fam-staging \
              #       fam-staging=unicef/etools-ap:$(Build.SourceVersion)
              #   displayName: Deploy application
              - script: |
                  kubectl -n etools-staging \
                    get pods
                displayName: Deploy application

              - script: |
                  kubectl rollout status deployment/fam-staging \
                    -n etools-staging \
                    --timeout=300s
                displayName: Wait for pods to start
                