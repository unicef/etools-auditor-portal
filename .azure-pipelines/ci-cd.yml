trigger:
  branches:
    include:
      - '*'
  tags:
    include:
      - '*'

pr:
  branches:
    include:
      - '*'

variables:
  NODE_VERSION: '22.21.1'
  DOCKER_IMAGE: 'unicef/etools-ap'

stages:
- stage: Lint
  displayName: Lint
  jobs:
    - job: Lint
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self
          fetchDepth: 1

        - task: NodeTool@0
          displayName: 'Use Node.js $(NODE_VERSION)'
          inputs:
            versionSpec: '$(NODE_VERSION)'

        - script: npm ci
          displayName: Install dependencies

        - script: npm run lint
          displayName: Run ESLint

- stage: BuildAndPush
  displayName: Docker Image build and push
  dependsOn: Lint
  condition: |
    and(
      succeeded(),
      or(
        startsWith(variables['Build.SourceBranch'], 'refs/tags/'),
        eq(variables['Build.SourceBranch'], 'refs/heads/master'),
        eq(variables['Build.SourceBranch'], 'refs/heads/staging'),
        eq(variables['Build.SourceBranch'], 'refs/heads/develop')
      )
    )

  jobs:
    - job: Docker
      pool:
        vmImage: ubuntu-latest
      steps:
        - checkout: self
          fetchDepth: 0

        # SAFE_BRANCH is derived from Build.SourceBranchName.
        # - On branch builds: it is the branch name (sanitized)
        # - On tag builds: it is the *tag name* (sanitized)
        # SAFE_BRANCH is used everywhere, so we NEVER use Build.SourceBranchName directly to avoid invalid Docker tags
        - script: |
            SAFE_BRANCH=$(echo "$(Build.SourceBranchName)" \
              | tr '/' '-' \
              | tr -cd 'a-zA-Z0-9._-')
            echo "##vso[task.setvariable variable=SAFE_BRANCH;isOutput=true]$SAFE_BRANCH"
          name: sanitize
          displayName: Sanitize branch name

        - script: |
            sed -i "0,/revNo/s//$(Build.SourceVersion)/" index.html
            sed -i "0,/revNo/s//$(Build.SourceVersion)/" version.json
            sed -i "0,/bDate/s//$(date -u +%F_%T)/" index.html
            sed -i "0,/bDate/s//$(date -u +%F_%T)/" version.json
          displayName: Inject build metadata

        - task: Docker@2
          displayName: Build and push image
          inputs:
            command: buildAndPush
            repository: $(DOCKER_IMAGE)
            dockerfile: Dockerfile
            containerRegistry: dockerhub
            tags: |
              $(sanitize.SAFE_BRANCH)
              $(Build.SourceVersion)

- stage: DeployDevelop
  displayName: Deploy to Develop (Rancher)
  dependsOn: BuildAndPush
  condition: |
    and(
      succeeded(),
      eq(variables['Build.SourceBranch'], 'refs/heads/develop')
    )

  variables:
    - group: rke-cluster-devtst

  jobs:
  - deployment: Deploy
    displayName: Deploy to develop
    environment: dev
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:
            - task: KubectlInstaller@0
              displayName: Install kubectl
              inputs:
                kubectlVersion: 'v1.16.2'

            - script: |
                mkdir -p ~/.kube
                echo "$(KUBECONFIG_B64)" | base64 -d > ~/.kube/config
                chmod 600 ~/.kube/config
                kubectl config use-context rke-cluster-devtst
              displayName: Configure kubeconfig

            - script: |
                kubectl -n etools-dev \
                  set image deployment/fam-dev \
                  fam-dev=$(DOCKER_IMAGE):$(Build.SourceVersion)
              displayName: Deploy application

            - script: |
                kubectl rollout status deployment/fam-dev \
                  -n etools-dev \
                  --timeout=300s
              displayName: Wait for pods to start

- stage: DeployStaging
  displayName: Deploy to Staging (Rancher)
  dependsOn: BuildAndPush
  condition: |
    and(
      succeeded(),
      eq(variables['Build.SourceBranch'], 'refs/heads/staging')
    )

  variables:
    - group: rke-cluster-etstgtrn

  jobs:
  - deployment: Deploy
    displayName: Deploy to staging
    environment: staging
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:
            - task: KubectlInstaller@0
              displayName: Install kubectl
              inputs:
                kubectlVersion: 'v1.16.2'

            - script: |
                mkdir -p ~/.kube
                echo "$(KUBECONFIG_B64)" | base64 -d > ~/.kube/config
                chmod 600 ~/.kube/config
                kubectl config use-context rke-cluster-etstgtrn
              displayName: Configure kubeconfig

            - script: |
                kubectl -n etools-staging \
                  set image deployment/fam-staging \
                  fam-staging=$(DOCKER_IMAGE):$(Build.SourceVersion)
              displayName: Deploy application

            - script: |
                kubectl rollout status deployment/fam-staging \
                  -n etools-staging \
                  --timeout=300s
              displayName: Wait for pods to start

- stage: DeployProd
  displayName: Deploy to Production (Rancher)
  dependsOn: BuildAndPush
  condition: |
    and(
      succeeded(),
      startsWith(variables['Build.SourceBranch'], 'refs/tags/')
    )

  variables:
    - group: rke-cluster-etools
    - name: SAFE_BRANCH
      value: $[ stageDependencies.BuildAndPush.Docker.outputs['sanitize.SAFE_BRANCH'] ]

  jobs:
  - deployment: Deploy
    displayName: Deploy to production
    environment: prod
    pool:
      vmImage: ubuntu-latest
    strategy:
      runOnce:
        deploy:
          steps:
            - task: KubectlInstaller@0
              displayName: Install kubectl
              inputs:
                kubectlVersion: 'v1.16.2'

            - script: |
                mkdir -p ~/.kube
                echo "$(KUBECONFIG_B64)" | base64 -d > ~/.kube/config
                chmod 600 ~/.kube/config
                kubectl config use-context rke-cluster-etools
              displayName: Configure kubeconfig

            # Deploy sanitized tag (SAFE_BRANCH). For tag-triggered runs, SAFE_BRANCH == sanitized Git tag
            - script: |
                kubectl -n etools-prod \
                  set image deployment/fam-prod \
                  fam-prod=$(DOCKER_IMAGE):$(SAFE_BRANCH)
              displayName: Deploy application

            - script: |
                kubectl rollout status deployment/fam-prod \
                  -n etools-prod \
                  --timeout=300s
              displayName: Wait for pods to start
