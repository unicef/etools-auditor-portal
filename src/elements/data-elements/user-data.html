<!--import [polymer, etools-ajax/etools-ajax-request-behavior, lodash]-->
<!--import [permission-controller, user-controller]-->

<dom-module id="user-data">
    <template>

    </template>

    <script>
        Polymer({
            is: 'user-data',

            behaviors: [
                etoolsAppConfig.globals,
                APBehaviors.PermissionController,
                APBehaviors.UserController,
                EtoolsAjaxRequestBehavior
            ],

            properties: {},

            ready: function () {
                this.sendRequest({
                    endpoint: this.getEndpoint('userProfile')
                }).then(resp => {
                   this._handleResponse(resp);
                }).catch(err => {
                    console.log(err)
                    this._handleError(err);
                });
            },

            _handleResponse: function (user) {
                let previousUserId = JSON.parse(localStorage.getItem('userId'));
                let countriesAvailable = _.get(user, 'countries_available') || [];

                countriesAvailable = _.sortBy(countriesAvailable, ['name']);
                _.set(user, 'countries_available', countriesAvailable);

                if (!previousUserId || previousUserId !== user.user) {
                    this.resetOldUserData();
                }

                localStorage.setItem('userId', user.user);

                this._setUserData(user);
                this.fire('user-profile-loaded');
            },

            _handleError: function (err) {
                if (err.status === 403) {
                    window.location.href = window.location.origin + '/';
                } else {
                    console.error('Can\'t load user data');
                }
            },

        });
    </script>
</dom-module>
