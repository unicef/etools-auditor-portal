<!--import [polymer, etools-ajax/etools-ajax-request-behavior]-->

<dom-module id="add-new-engagement">
    <template>
        
    </template>

    <script>
        Polymer({
            is: 'add-new-engagement',

            behaviors: [
                etoolsAppConfig.globals,
                EtoolsAjaxRequestBehavior
            ],

            properties: {
                newEngagementData: {
                    type: Object
                },
                errorObject: {
                    type: Object,
                    notify: true,
                    value: function() {
                        return {};
                    }
                },
                endpointName: {
                    type: String,
                    value: ''
                }
            },

            observers: ['_newEngagementChanged(newEngagementData, endpointName)'],

            _handleResponse: function (data) {
                this.fire('engagement-created', {success: true, data});
            },

            _handleError: function (error) {
                let {status, response} = error;
                if (typeof response === 'string') {
                    try {
                        response = JSON.parse(response);
                    } catch (e) {
                        response = {};
                    }
                }

                if (status === 400) {
                    this.set('errorObject', response);
                } else if(status === 413) {
                    this.set('errorObject', {});
                    this.fire('toast', {text: `Error: Exceeded the maximum size of uploaded file(s).`});
                }

                this.fire('engagement-created');
                this.fire('global-loading', {type: 'create-engagement'});
            },

            _newEngagementChanged: function(engagement, endpointName) {
                if (!engagement || !endpointName) { return; }
                let url = this.getEndpoint(endpointName).url;

                this.fire('global-loading', {type: 'create-engagement', active: true, message: 'Creating new engagement...'});
                this.postData = engagement.data;
                this._makeRequest(endpointName)
            },

            _makeRequest(endpointName) {
                const options = {
                    method: 'POST',
                    body: this.postData,
                    endpoint: this.getEndpoint(endpointName)
                };
                this.sendRequest(options)
                    .then(this._handleResponse.bind(this))
                    .catch(this._handleError.bind(this))
            }
        });
    </script>
</dom-module>
