<!--import [polymer, etools-ajax/etools-ajax-request-behavior, lodash]-->
<!--import [last-created-behavior, permission-controller]-->

<dom-module id="engagement-info-data">
    <template>
     
    </template>

    <script>
        'use strict';

        Polymer({
            is: 'engagement-info-data',

            behaviors: [
                etoolsAppConfig.globals,
                APBehaviors.LastCreatedController,
                APBehaviors.PermissionController,
                EtoolsAjaxRequestBehavior
            ],

            properties: {
                engagementId: {
                    type: Number,
                    notify: true,
                    observer: '_idChanged'
                },
                engagementType: String,
                engagementInfo: {
                    type: Object,
                    notify: true,
                    observer: '_setToResponse'
                },
                lastId: Number,
                requestsCompleted: {
                    type: Object,
                    value: {}
                },
                reportAtmOptions: {
                    postfix: 'report_attachments',
                    requestName: 'reportAttachments'
                },
                atmOptions: {
                    postfix: 'attachments',
                    requestName: 'attachments'
                }
            },
            
            _handleDataResponse: function(data) {
                this.responseData = data;
                this.requestsCompleted.data = true;
                this._finishRequests(this.responseData || {});
            },

            _handleOptionsResponse: function(data) {
                let actions = _.get(data,'actions', null);
                if (actions) {
                    this._addToCollection(`engagement_${this.engagementId}`, actions);
                } else {
                    console.error('Can not load permissions for engagement');
                }

                this.requestsCompleted.options = true;
                this._finishRequests(this.responseData || {});
            },

            _handleDataOptionsResponse: function(data, params) {
                let actions = _.get(data, 'actions', {}),
                    name = _.get(data, 'name', '');
                this._handleEngagementOptions(params, actions, name);
            },


            _handleEngagementOptions: function ({postfix, requestName}, actions, name) {
                this._addToCollection(`engagement_${this.engagementId}_${postfix}`, actions, name);
                this.requestsCompleted[requestName] = true;
                this._finishRequests(this.responseData || {});
            },

            _finishRequests: function(data) {
                if (!this.requestsCompleted.data ||
                    !this.requestsCompleted.apOptions ||
                    !this.requestsCompleted.options ||
                    !this.requestsCompleted.attachments ||
                    !this.requestsCompleted.reportAttachments) { return; }

                if (data) { this.engagementInfo = data; }
                
                this.fire('global-loading', {type: 'engagement-info'});
                this.fire('engagement-info-loaded');
                this.engagementId = null;
                this.lastError = false;
            },

            _handleError: function () {
                this.fire('global-loading', {type: 'engagement-info'});
                this.fire('404', {message: 'Partner not found!'});
                this.engagementId = null;
                this.lastError = true;
            },

            _handleOptionsError: function (error, params) {
              if (error.status === 403) {
                  this._handleEngagementOptions(params, {}, '');
              }
            },

       
            _setToResponse: function(engagement) {
                if (engagement && engagement.id && !_.isEqual(this.responseData, engagement)) {
                    this.responseData = engagement;
                }
            },

            _makeOptionsRequest: function (params, endpoint) {
                const options = {
                    method: 'OPTIONS',
                    endpoint
                };
                this.sendRequest(options)
                    .then((resp)=>this._handleDataOptionsResponse(resp, params))
                    .catch((error)=>this._handleOptionsError(error, params));
            },

            _idChanged: function(id) {
                if (!id || isNaN(id) || !this.engagementType) { return; }
                if (+id === this.lastId) {
                    this.lastError ? this._handleError() : this._finishRequests(this.responseData || {});
                    return;
                }

                this.lastId = id;
                this.engagementInfo = {};
                this.requestsCompleted = {};

                this.fire('global-loading', {message: 'Loading engagement data...', active: true, type: 'engagement-info'});

                let apBaseUrl = this.getEndpoint('engagementInfo', {id: id, type: 'engagements'}).url;
                this._makeOptionsRequest({
                    postfix: 'ap',
                    requestName: 'apOptions'
                }, {url: `${apBaseUrl}action-points/`});

                this._makeOptionsRequest({
                    postfix: 'attachments',
                    requestName: 'attachments'
                }, this.getEndpoint('attachments', {id: id}));

                this._makeOptionsRequest({
                    postfix: 'report_attachments',
                    requestName: 'reportAttachments'
                }, this.getEndpoint('reportAttachments', {id: id}));
                

                let lastCreated = this.getLastEngagementData(id);
                // load engagement info if it was just created
                if (lastCreated) {
                    this._handleDataResponse(lastCreated);
                    this._requestOptions(id);
                    return;
                }

                // otherwise fetch info
                
                this._getEngagementInfo(id);

                if (this.collectionExists(`engagement_${id}`)) {
                    this.requestsCompleted.options = true;
                } else {
                    this._requestOptions(id);
                }
            },

            _getEngagementInfo: function (id) {
                const options = {
                    endpoint: this.getEndpoint('engagementInfo', {id, type: this.engagementType})
                };
                this.sendRequest(options)
                    .then(this._handleDataResponse.bind(this))
                    .catch(this._handleError.bind(this));
            },

            _requestOptions: function (id) {
                const options = {
                    method: 'OPTIONS',
                    endpoint: this.getEndpoint('engagementInfo', { id, type: this.engagementType })
                };
                this.sendRequest(options)
                    .then(this._handleOptionsResponse.bind(this))
                    .catch(this._handleOptionsResponse.bind(this));
            }
        });
    </script>
</dom-module>
