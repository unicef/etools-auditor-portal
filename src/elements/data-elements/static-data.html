<!--import [polymer, etools-ajax, lodash]-->
<!--import [static-data-behavior, permission-controller, user-controller, user-data]-->

<dom-module id="static-data">
    <template>
        <user-data></user-data>

        <!--partners-->
        <etools-ajax
                endpoint="[[partnersEndpoint]]"
                caching-storage="custom"
                dexie-db-collection="partners"
                on-success="_partnersLoaded"
                on-forbidden="_partnersLoaded"
                on-fail="_partnersLoaded">
        </etools-ajax>

        <!--filterAuditors-->
        <etools-ajax
                url="[[filterAuditorsUrl]]"
                on-success="_filterAuditorsLoaded"
                on-forbidden="_filterAuditorsLoaded"
                on-fail="_filterAuditorsLoaded">
        </etools-ajax>

        <!--filterPartners-->
        <etools-ajax
                url="[[filterPartnersUrl]]"
                on-success="_filterPartnersLoaded"
                on-forbidden="_filterPartnersLoaded"
                on-fail="_filterPartnersLoaded">
        </etools-ajax>

        <!--engagement creation-->
        <etools-ajax
                method="OPTIONS"
                url="{{newEngagementPermissions}}"
                on-success="_handleNewEngagementResponse"
                on-forbidden="_handleNewEngagementResponse"
                on-fail="_handleNewEngagementResponse">
        </etools-ajax>

        <!--users-->
        <etools-ajax
                method="GET"
                url="{{usersEndpoint}}"
                on-success="_handleUsersResponse"
                on-forbidden="_handleUsersResponse"
                on-fail="_handleUsersResponse">
        </etools-ajax>
    </template>

    <script>
        (function() {
            'use strict';

            let dataLoaded = {};

            Polymer({
                is: 'static-data',

                behaviors: [
                    etoolsAppConfig.globals,
                    APBehaviors.StaticDataController,
                    APBehaviors.PermissionController,
                    APBehaviors.UserController,
                ],

                properties: {},

                listeners: {
                    'user-profile-loaded': 'loadStaticData'
                },

                attached: function() {
                    document.addEventListener('update-engagements-filters', this._updateEngagementsFilters.bind(this));
                },

                detached: function() {
                    document.removeEventListener('update-engagements-filters', this._updateEngagementsFilters);
                },

                loadStaticData: function () {
                    this.partnersEndpoint = this.getEndpoint('partnerOrganisations');
                    this.usersEndpoint = this.getEndpoint('users').url;
                    this.newEngagementPermissions = this.getEndpoint('createEngagement').url;
                },

                _allDataLoaded: function() {
                    if (dataLoaded.partners && dataLoaded.engagementOptions && dataLoaded.users) {
                        this.fire('static-data-loaded');
                    }
                },

                _filtersDataLoaded: function() {
                    if (dataLoaded.filterAuditors && dataLoaded.filterPartners) {
                        this._triggerGlobalEvent('engagements-filters-updated');

                        dataLoaded.filters = true;
                        dataLoaded.filterAuditors = false;
                        dataLoaded.filterPartners = false;
                    }
                },

                _triggerGlobalEvent: function(eventName, data) {
                    let detail = {detail: data};
                    let event = new CustomEvent(eventName, detail);
                    document.dispatchEvent(event);
                },

                _updateEngagementsFilters: function() {
                    let time = new Date().getTime();

                    this.filterAuditorsUrl = this.getEndpoint('filterAuditors').url + `?reload=${time}`;
                    this.filterPartnersUrl = this.getEndpoint('filterPartners').url + `?reload=${time}`;
                },

                _partnersLoaded: function(event, details) {
                    if (!details || details.error) {
                        this._responseError('Partners', event && event.type);
                    } else {
                        let partners = _.sortBy(details, ['name']);
                        this._setData('partners', partners);
                    }
                    dataLoaded.partners = true;
                    this._allDataLoaded();
                },

                _filterAuditorsLoaded: function(event, details) {
                    if (!details || details.error) {
                        this._responseError('Auditors', event && event.type);
                    }

                    let filterAuditors = details && details.results || [];
                    if (dataLoaded.filters) {
                        this._updateData('filterAuditors', filterAuditors);
                    } else {
                        this._setData('filterAuditors', filterAuditors);
                    }

                    dataLoaded.filterAuditors = true;
                    this._filtersDataLoaded();
                },

                _filterPartnersLoaded: function(event, details) {
                    if (!details || details.error) {
                        this._responseError('Partners', event && event.type);
                    }

                    let filterPartners = details || [];
                    if (dataLoaded.filters) {
                        this._updateData('filterPartners', filterPartners);
                    } else {
                        this._setData('filterPartners', filterPartners);
                    }

                    dataLoaded.filterPartners = true;
                    this._filtersDataLoaded();
                },

                _handleNewEngagementResponse: function(event, details) {
                    let actions = details && details.actions;
                    if (!details || details.error || !this.isValidCollection(actions)) {
                        this._responseError('Engagement Permissions', event && event.type);
                    } else {
                        this._addToCollection('new_engagement', actions);

                        let statuses = this.getChoices('new_engagement.status') || [];
                        let engagementTypes = this.getChoices('new_engagement.engagement_type') || [];

                        if (!statuses) { this._responseError('Statuses', 'Can not load engagement statuses data'); }
                        if (!engagementTypes) { this._responseError('Engagement types', 'Can not load engagement types data'); }

                        this._setData('statuses', statuses);
                        this._setData('engagementTypes', engagementTypes);
                    }

                    dataLoaded.engagementOptions = true;
                    this._allDataLoaded();
                },

                _handleUsersResponse: function(event, details) {
                    if (!details || details.error) {
                        this._responseError('Users', event && event.type);
                    } else {
                        _.each(details, (user) => {
                            user.full_name = `${user.first_name} ${user.last_name}`;
                        });
                        this._setData('users', details);
                    }
                    dataLoaded.users = true;
                    this._allDataLoaded();
                },

                _responseError: function(message, type, eventType = 'error') {
                    console[eventType](`Can not load initial data: ${message || '?'}. Reason: ${type || '?'}`);
                }
            });
        })();
    </script>
</dom-module>
