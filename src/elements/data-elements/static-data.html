<!--import [polymer, etools-ajax, static-data-behavior, permission-controller]-->

<dom-module id="static-data">

    <template>

        <!--partners-->
        <etools-ajax
                endpoint="[[partnersEndpoint]]"
                caching-storage="custom"
                dexie-db-collection="partners"
                on-success="_partnersLoaded"
                on-forbidden="_responseError"
                on-fail="_responseError"></etools-ajax>

        <!--auditors-->
        <etools-ajax
                endpoint="[[auditorsEndpoint]]"
                caching-storage="custom"
                dexie-db-collection="auditors"
                on-success="_auditorsLoaded"
                on-fail="_auditorsError"></etools-ajax>

        <etools-ajax method="OPTIONS"
                     url="{{newEngagementPermissions}}"
                     on-success="_handleNewEngagementResponse"
                     on-fail="_responseError"></etools-ajax>

    </template>

    <script>

        (function() {
            'use strict';

            let dataLoaded = {};

            Polymer({

                is: 'static-data',
                behaviors: [
                    etoolsAppConfig.globals,
                    APBehaviors.StaticDataController,
                    APBehaviors.PermissionController
                ],

                properties: {},

                ready: function () {
                    //TODO: CHANGE after engagements options api will works
                    this.auditorsEndpoint = this.getEndpoint('auditOrganisations');
                    this.newEngagementPermissions = this.getEndpoint('createEngagement', {type: 'micro-assessments'}).url;
//                    this.newEngagementPermissions = this.getEndpoint('createEngagement', {type: 'engagements'}).url;
                },

                _allDataLoaded: function() {
                    if (dataLoaded.partners && dataLoaded.auditors && dataLoaded.engagementOptions) {
                        this.fire('static-data-loaded');
                    }
                },

                _partnersLoaded: function(data) {
                    this._setData('partners', data.detail);
                    dataLoaded.partners = true;
                    this._allDataLoaded();
                },

                _auditorsLoaded: function(data) {
                    this._setData('auditors', data.detail);
                    dataLoaded.auditors = true;
                    this._allDataLoaded();
                },

                _handleNewEngagementResponse: function(data) {
                    let actions = data && data.detal && data.detail.actions;
                    if (!actions) { this._responseError(); }

                    if (actions.POST) {
                        data.detail.actions.POST.type.read_only = false; //TODO: remove this line when using /engagement/ OPTIONS api
                        data.detail.actions.POST.type.required = true; //TODO: remove this line when using /engagement/ OPTIONS api

                        this._addToCollection('new_engagement', data.detail.actions.POST);
                        this.partnersEndpoint = this.getEndpoint('partnerOrganisations');

                        //TODO: move this logic to GET actions
                        let attachmentsTypes = this.getChoices('new_engagement.attachments.file_type');
                        if (!attachmentsTypes) {
                            this._responseError();
                            return;
                        }
                        this._setData('attachments_types', attachmentsTypes);
                    } else {
                        dataLoaded.partners = true;
                    }

//                    if (actions.GET) {
//                        let attachmentsTypes = this.getChoices('new_engagement.attachments.file_type');
//                        if (!attachmentsTypes) {
//                            this._responseError();
//                            return;
//                        }
//                        this._setData('attachments_types', attachmentsTypes);
//                    }

                    dataLoaded.engagementOptions = true;
                    this._allDataLoaded();
                },

                _responseError: function() {
                    console.error('Can not load initial data');
                    this.fire('static-data-loaded');
                }

            });

        })();

    </script>

</dom-module>
