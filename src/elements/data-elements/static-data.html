<!--import [polymer, etools-ajax, etools-ajax/etools-ajax-request-behavior, lodash]-->
<!--import [static-data-behavior, permission-controller, user-controller, user-data]-->

<dom-module id="static-data">
    <template>
        <user-data></user-data>

        <!--partners-->
        <etools-ajax
                endpoint="[[partnersEndpoint]]"
                caching-storage="custom"
                dexie-db-collection="partners"
                on-success="_partnersLoaded"
                on-forbidden="_partnersLoaded"
                on-fail="_partnersLoaded">
        </etools-ajax>

        <!--filterAuditors-->
        <etools-ajax
                url="[[filterAuditorsUrl]]"
                on-success="_filterAuditorsLoaded"
                on-forbidden="_filterAuditorsLoaded"
                on-fail="_filterAuditorsLoaded">
        </etools-ajax>

        <!--filterPartners-->
        <etools-ajax
                url="[[filterPartnersUrl]]"
                on-success="_filterPartnersLoaded"
                on-forbidden="_filterPartnersLoaded"
                on-fail="_filterPartnersLoaded">
        </etools-ajax>

        <!--users-->
        <etools-ajax
                method="GET"
                url="{{usersEndpoint}}"
                on-success="_handleUsersResponse"
                on-forbidden="_handleUsersResponse"
                on-fail="_handleUsersResponse">
        </etools-ajax>

        <!--staff_members__user-->
        <etools-ajax
                method="GET"
                url="{{staffUsersEndpoint}}"
                on-success="_handleStaffUsersResponse"
                on-forbidden="_handleStaffUsersResponse"
                on-fail="_handleStaffUsersResponse">
        </etools-ajax>

        <!--sections-->
        <etools-ajax
                method="GET"
                endpoint="{{sectionsEndpoint}}"
                caching-storage="custom"
                dexie-db-collection="sections"
                cache-key="sections"
                on-success="_apDataResponse"
                on-forbidden="_apDataResponse"
                on-fail="_apDataResponse">
        </etools-ajax>

        <!--offices-->
        <etools-ajax
                method="GET"
                endpoint="{{officesEndpoint}}"
                caching-storage="custom"
                dexie-db-collection="offices"
                cache-key="offices"
                on-success="_apDataResponse"
                on-forbidden="_apDataResponse"
                on-fail="_apDataResponse">
        </etools-ajax>
    </template>

    <script>
        (function() {
            'use strict';

            let dataLoaded = {};

            Polymer({
                is: 'static-data',

                behaviors: [
                    etoolsAppConfig.globals,
                    APBehaviors.StaticDataController,
                    APBehaviors.PermissionController,
                    APBehaviors.UserController,
                    EtoolsAjaxRequestBehavior
                ],

                properties: {
                    optionsParams: {
                        type: Object,
                        value: {
                            method: 'OPTIONS'
                        }
                    }
                },

                listeners: {
                    'user-profile-loaded': 'loadStaticData'
                },

                attached: function() {
                    document.addEventListener('update-engagements-filters', this._updateEngagementsFilters.bind(this));
                },

                detached: function() {
                    document.removeEventListener('update-engagements-filters', this._updateEngagementsFilters);
                },

                loadStaticData: function () {
                    this.partnersEndpoint = this.getEndpoint('partnerOrganisations');
                    this.usersEndpoint = this.getEndpoint('users').url;
                    this.staffUsersEndpoint = this.getEndpoint('staffMembersUsers').url;
                    this.officesEndpoint = this.getEndpoint('offices');
                    this.sectionsEndpoint = this.getEndpoint('sectionsCovered');
                    this._getStaticDropdownData();

                    this.makeOptionsCalls();
                    
                },

                _getStaticDropdownData: function () {
                    const reqOpts = {
                        csrf: true,
                        endpoint: this.getEndpoint('static')
                    };
                    this.sendRequest(reqOpts).then(resp=> this._setData('staticDropdown', resp));
                },

                makeOptionsCalls: function() {
                    this.getEngagementOptions();
                    this.getNewStaffSCOptions();
                    this.getAtmOptions();
                },

                getEngagementOptions: function() {
                    const options = {
                        endpoint: this.getEndpoint('createEngagement'),
                        csrf: true,
                        method: 'OPTIONS'
                    }
                    this.sendRequest(options)
                    .then(this._handleNewEngagementResponse.bind(this))
                    .catch(this._handleNewEngagementResponse.bind(this));
                },
                
                getNewStaffSCOptions: function() {
                    const options = {
                        endpoint: this.getEndpoint('staffSCList'),
                        csrf: true,
                        method: 'OPTIONS'
                    }
                    this.sendRequest(options)
                    .then(this._handleStaffSCOptionsResponse.bind(this))
                    .catch(this._handleStaffSCOptionsResponse.bind(this));
                },

                getAtmOptions: function() {
                    const options = {
                        endpoint: this.getEndpoint('attachments', {id: 'new'}),
                        csrf: true,
                        method: 'OPTIONS'
                    }
                    this.sendRequest(options)
                    .then(this._atmOptionsResponse.bind(this))
                    .catch(this._atmOptionsResponse.bind(this));
                },

                _allDataLoaded: function() {
                    if (dataLoaded.partners &&
                        dataLoaded.engagementOptions &&
                        dataLoaded.users &&
                        dataLoaded.staffUsers &&
                        dataLoaded.attachmentsOptions) {
                        this.fire('static-data-loaded');
                    }
                },

                _filtersDataLoaded: function() {
                    if (dataLoaded.filterAuditors && dataLoaded.filterPartners) {
                        this._triggerGlobalEvent('engagements-filters-updated');

                        dataLoaded.filters = true;
                        dataLoaded.filterAuditors = false;
                        dataLoaded.filterPartners = false;
                    }
                },

                _triggerGlobalEvent: function(eventName, data) {
                    let detail = {detail: data};
                    let event = new CustomEvent(eventName, detail);
                    document.dispatchEvent(event);
                },

                _updateEngagementsFilters: function() {
                    let time = new Date().getTime();

                    this.filterAuditorsUrl = this.getEndpoint('filterAuditors').url + `?reload=${time}`;
                    this.filterPartnersUrl = this.getEndpoint('filterPartners').url + `?reload=${time}`;
                },

                _partnersLoaded: function(event, details) {
                    if (!details || details.error) {
                        this._responseError('Partners', event && event.type, 'warn');
                    } else {
                        let partners = _.sortBy(details, ['name']);
                        this._setData('partners', partners);
                    }
                    dataLoaded.partners = true;
                    this._allDataLoaded();
                },

                _filterAuditorsLoaded: function(event, details) {
                    if (!details || details.error) {
                        this._responseError('Auditors', event && event.type);
                    }
                    let filterAuditors = details || details.results || [];
                    if (dataLoaded.filters) {
                        this._updateData('filterAuditors', filterAuditors);
                    } else {
                        this._setData('filterAuditors', filterAuditors);
                    }

                    dataLoaded.filterAuditors = true;
                    this._filtersDataLoaded();
                },

                _filterPartnersLoaded: function(event, details) {
                    if (!details || details.error) {
                        this._responseError('Partners', event && event.type);
                    }

                    let filterPartners = details || [];
                    if (dataLoaded.filters) {
                        this._updateData('filterPartners', filterPartners);
                    } else {
                        this._setData('filterPartners', filterPartners);
                    }

                    dataLoaded.filterPartners = true;
                    this._filtersDataLoaded();
                },

                _handleNewEngagementResponse: function(details) {
                    let actions = details && details.actions;
                    if (!details || details.error || !this.isValidCollection(actions)) {
                        this._responseError('Engagement Permissions', details.error);
                    } else {
                        this._addToCollection('new_engagement', actions);

                        let statuses = this.getChoices('new_engagement.status') || [];
                        let engagementTypes = this.getChoices('new_engagement.engagement_type') || [];

                        if (!statuses) { this._responseError('Statuses', 'Can not load engagement statuses data'); }
                        if (!engagementTypes) { this._responseError('Engagement types', 'Can not load engagement types data'); }

                        this._setData('statuses', statuses);
                        this._setData('engagementTypes', engagementTypes);
                    }

                    dataLoaded.engagementOptions = true;
                    this._allDataLoaded();
                },

                _handleStaffSCOptionsResponse: function(data) {
                    let actions = _.get(data, 'actions') || {},
                        name = _.get(data, 'name', ''),
                        collection = 'new_staff_sc',
                        dataName  = 'staffSCPermissions'

                    if (!collection || !dataName) {
                        throw new Error('Please provide collection and dataName attributes');
                    }

                    this._addToCollection(collection, actions, name);
                    dataLoaded[dataName] = true;
                },

                _atmOptionsResponse: function(data) {
                    let actions = _.get(data, 'actions', {}),
                            name = _.get(data, 'name', '');

                    if (actions) {
                        this._addToCollection(`new_engagement_attachments`, actions || {}, name);
                        this._addToCollection(`new_staff_sc_attachments`, actions || {}, name);
                    } else {
                        this._responseError('Engagement Attachments Permissions', data && data.type);
                    }

                    dataLoaded.attachmentsOptions = true;
                    this._allDataLoaded();
                },

                _handleUsersResponse: function(event, details) {
                    if (!details || details.error) {
                        this._responseError('Users', event && event.type, 'warn');
                    } else {
                        _.each(details, (user) => {
                            user.full_name = user.first_name || user.last_name ?
                                    `${user.first_name} ${user.last_name}` :
                                    'Unnamed User';
                        });
                        this._setData('users', details);
                    }
                    dataLoaded.users = true;
                    this._allDataLoaded();
                },

                _handleStaffUsersResponse: function(event, details) {
                    if (!details || details.error) {
                        this._responseError('Staff Members Users', event && event.type, 'warn');
                    } else {
                        _.each(details, (user) => {
                            user.full_name = user.first_name || user.last_name ?
                                    `${user.first_name} ${user.last_name}` :
                                    'Unnamed User';
                        });
                        this._setData('staffMembersUsers', details);
                    }
                    dataLoaded.staffUsers = true;
                    this._allDataLoaded();
                },

                _apDataResponse: function(event, details) {
                    let collection = _.invoke(event, 'srcElement.getAttribute', 'cache-key');

                    if (!collection || !details) { return; }
                    this._setData(collection, details);
                },

                _responseError: function(message, type, eventType = 'error') {
                    console[eventType](`Can not load initial data: ${message || '?'}. Reason: ${type || '?'}`);
                }
            });
        })();
    </script>
</dom-module>
