<!--import [polymer, etools-ajax/etools-ajax-request-behavior, lodash]-->
<!--import [etools-app-config]-->

<dom-module id="update-staff-members">
    <template>
    </template>

    <script>
        Polymer({
            is: 'update-staff-members',

            behaviors: [
                etoolsAppConfig.globals,
                EtoolsAjaxRequestBehavior
            ],

            properties: {
                organisationId: Number,
                staffData: {
                    type: Object,
                    notify: true,
                    observer: '_dataChanged'
                }
            },

            _dataChanged: function(data) {
                if (!data) { return; }
                if (!this.organisationId) { throw 'Organisation id is not provided!'; }
                if (!data.method || !data.data) { throw 'Method or data are missing!'}

                this.lastRequestData = _.cloneDeep(data);

                // this.method = data.method;
                // this.url = this.getEndpoint('staffMembers', {id: this.organisationId}).url + data.id;
                // this.postData = data.data;
                this.set('staffData', null);
                const options = {
                    method: data.method,
                    endpoint: {
                        url: this.getEndpoint('staffMembers', {id: this.organisationId}).url + data.id
                    },
                    body: data.data
                }
                this.sendRequest(options)
                    .then(this._handleResponse.bind(this))
                    .catch(this._handleError.bind(this));
            },


            _handleResponse: function(detail) {
                this.fire('staff-updated', {
                    action: this.lastRequestData.method.toLowerCase(),
                    data: detail,
                    hasAccess: this.lastRequestData.data.hasAccess,
                    index: this.lastRequestData.staffIndex
                });
            },

            _handleError: function(event, error) {
                let responseData = error && error.request && error.request.detail &&
                        error.request.detail.request && error.request.detail.request.xhr;

                let {status, response} = responseData || {};
                if (typeof response === 'string') {
                    try {
                        response = JSON.parse(response);
                    } catch (e) {
                        response = {};
                    }
                }

                this.fire('staff-updated', {error: true, errorData: response, status: status});
            }
        });
    </script>
</dom-module>
