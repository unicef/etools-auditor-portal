<!--import [polymer, etools-ajax/etools-ajax-request-behavior, lodash]-->
<!--import [etools-app-config, static-data-behavior]-->

<dom-module id="get-partner-data">
    <template>

    </template>

    <script>
        Polymer({
            is: 'get-partner-data',

            behaviors: [
                etoolsAppConfig.globals,
                APBehaviors.StaticDataController,
                EtoolsAjaxRequestBehavior
            ],

            properties: {
                partnerId: {
                    type: Number,
                    notify: true,
                    observer: '_partnerIdChanged'
                },
                partner: {
                    type: Object,
                    notify: true
                }
            },

            _handleResponse: function (detail) {
                if (!detail || !detail.id) {
                    this._handleError();
                    return;
                }
                this.lastData = _.clone(detail);
                let officers = this.getData(`officers_${detail.id}`);
                if (officers) {
                    this.lastData.partnerOfficers = officers;
                    this.finishRequest();
                } else {
                    this.sendRequest({
                        endpoint: {url: this.getEndpoint('authorizedOfficers', {id: detail.id}).url}
                    }).then(resp => {
                        this._handleOfficersResponse(resp);
                    }).catch(err => {
                        this._handleOfficersError(err);
                    });
                }
            },

            _handleOfficersResponse: function(detail) {
                if (!detail) {
                    this._handleOfficersError();
                } else {
                    let activePartnerOfficers = detail.filter((officer) => {
                        return officer && officer.active;
                    });
                    activePartnerOfficers = activePartnerOfficers.map((officer) => {
                        let partnerOfficer = _.clone(officer);
                        partnerOfficer.fullName = `${partnerOfficer.first_name} ${partnerOfficer.last_name}`;
                        return partnerOfficer;
                    });
                    this._setData(`officers_${this.lastData.id}`, activePartnerOfficers);
                    this.lastData.partnerOfficers = activePartnerOfficers;
                    this.finishRequest();
                }
            },

            finishRequest: function() {
                this.partner = _.clone(this.lastData);
                this.fire('partner-loaded', {success: true});

                let partnerDataId = `partner_${this.partner.id}`,
                    partner = this.getData(partnerDataId);
                if (!partner) {
                    this._setData(partnerDataId, this.partner);
                }
            },

            _handleOfficersError: function() {
                console.error('Can not load partner officers!');
                this.finishRequest();
            },

            _handleError: function () {
                this.lastError = true;
                this.fire('partner-loaded');
            },

            _partnerIdChanged: function(partnerId) {
                if (!partnerId) { return; }
                if (partnerId === this.lastNumber) {
                    this.partnerId = null;
                    let detail = _.clone(this.lastData)
                    this.lastError ? this._handleError() : this._handleResponse(detail);
                    return;
                }

                this.lastError = false;
                this.lastNumber = partnerId;

                let partner = this.getData(`partner_${partnerId}`);
                if (partner) {
                    this._handleResponse(partner);
                } else {
                    this.sendRequest({
                        endpoint: {url: this.getEndpoint('partnerInfo', {id: partnerId}).url}
                    }).then(resp => {
                        this._handleResponse(resp);
                    }).catch(err => {
                        this._handleError(err);
                    });
                }

                this.partnerId = null;
            }
        });
    </script>
</dom-module>
