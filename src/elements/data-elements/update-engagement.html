<!--import [polymer, etools-ajax/etools-ajax-request-behavior]-->

<dom-module id="update-engagement">
    <template>
        <!-- <etools-ajax
                method="{{method}}"
                url="{{url}}"
                body="{{postData}}"
                on-success="_handleResponse"
                on-fail="_handleError">
        </etools-ajax> -->

        <!-- <etools-ajax
                method="OPTIONS"
                url="[[optionsUrl]]"
                on-success="_handleOptionsResponse"
                on-fail="_handleOptionsError">
        </etools-ajax> -->

        <!-- <etools-ajax
                method="OPTIONS"
                url="[[apOptionsUrl]]"
                data-path-postfix="ap"
                data-request-name="apOptions"
                on-success="_handleDataOptionsResponse"
                on-fail="_handleDataOptionsResponse"
                on-forbidden="_handleDataOptionsResponse">
        </etools-ajax>

        <etools-ajax
                method="OPTIONS"
                url="[[attachments]]"
                data-path-postfix="attachments"
                data-request-name="attachments"
                on-success="_handleDataOptionsResponse"
                on-fail="_handleDataOptionsResponse"
                on-forbidden="_handleDataOptionsResponse">
        </etools-ajax>

        <etools-ajax
                method="OPTIONS"
                url="[[reportAttachments]]"
                data-path-postfix="report_attachments"
                data-request-name="reportAttachments"
                on-success="_handleDataOptionsResponse"
                on-fail="_handleDataOptionsResponse"
                on-forbidden="_handleDataOptionsResponse">
        </etools-ajax> -->
    </template>

    <script>
        Polymer({
            is: 'update-engagement',

            behaviors: [
                etoolsAppConfig.globals,
                APBehaviors.PermissionController,
                EtoolsAjaxRequestBehavior
            ],

            properties: {
                updatedEngagementData: {
                    type: Object,
                    observer: '_engagementChanged'
                },
                engagement: {
                    type: Object,
                    notify: true
                },
                basePermissionPath: {
                    type: String,
                    notify: true
                },
                quietAdding: {
                    type: Boolean,
                    notify: true
                },
                errorObject: {
                    type: Object,
                    notify: true,
                    value: () => ({})
                },
                optionRequests: {
                    type: Object,
                    notify: true,
                    value: () => ({})
                },
                forceOptionsUpdate: {
                    type: Boolean,
                    notify: true
                },
                requestOptions: {
                    type: Object
                }
            },

            _handleResponse: function (data) {
                if (this.requestOptions.method === 'POST' || this.forceOptionsUpdate) {
                    this.lastData = data;
                    this.forceOptionsUpdate = false;
                    this._finishPostResponse();
                    return;
                } else if (this.actionUrl) {
                    let engagement = data || {};
                    this._engagementChanged(engagement);
                    return;
                }
                this.finishResponse(data);
            },

            _handleOptionsResponse: function(data) {
                let collectionName = `engagement_${this.lastData.id}`;
                this._updateCollection(collectionName, data.actions);
                this.optionsUrl = '';

                this.optionRequests.options = true;
                this.finishOptionsResponse(this.lastData);
            },

            _handleDataOptionsResponse: function(postfix, requestName) {
                return data => {
                    let actions = _.get(data, 'actions', {}),
                    name = _.get(data, 'name', '');
                    // postfix = _.get(data, 'srcElement.dataset.pathPostfix'),
                    // requestName = _.get(data, 'srcElement.dataset.requestName');

                let collectionName = `engagement_${this.lastData.id}_${postfix}`;
                this._updateCollection(collectionName, actions || {}, name);
                this[requestName] = '';

                this.optionRequests[requestName] = true;
                this.finishOptionsResponse(this.lastData);
                }
            },

            finishOptionsResponse: function(data) {
                if (!this.optionRequests.options ||
                    !this.optionRequests.apOptions ||
                    !this.optionRequests.attachments ||
                    !this.optionRequests.reportAttachments) { return; }

                this.finishResponse(data);
            },

            finishResponse: function(data) {
                this.optionRequests = {};
                this.engagement = data;

                this.basePermissionPath = '';
                this.basePermissionPath = `engagement_${this.engagement.id}`;

                this.fire('engagement-updated', {success: true, data});
                this.fire('global-loading', {type: 'update-engagement'});
                this.fire('global-loading', {type: 'update-permissions'});

                let action;
                if (this.requestOptions.method === 'PATCH') {
                    action = 'saved';
                } else if (data.status === 'report_submitted') {
                    action = 'submitted';
                } else if (data.status === 'final') {
                    action = 'finalized';
                } else if (data.status === 'cancelled') {
                    action = 'cancelled';
                }

                if (!this.quietAdding) {
                    this.fire('toast', {text: `Engagement ${action !== 'saved' ? '' : 'data '}has been ${action}!`});
                } else {
                    this.quietAdding = false;
                }
            },

            _finishPostResponse: function() {
                if (!this.quietAdding) {
                    this.fire('global-loading', {type: 'update-permissions', active: true, message: 'Updating data...'});
                }

                if (~this.actionUrl.indexOf('submit')) {
                    this.fire('global-loading', {type: 'submit-engagement'});
                } else if (~this.actionUrl.indexOf('finalize')) {
                    this.fire('global-loading', {type: 'finalize-engagement'});
                } else if (~this.actionUrl.indexOf('cancel')) {
                    this.fire('global-loading', {type: 'cancel-engagement'});
                } else {
                    this.fire('global-loading', {type: 'update-engagement'});
                }
                this.actionUrl = '';

                const optionsEndpoint = this.getEndpoint('engagementInfo', { id: this.updatedEngagementData.id, type: this.updatedEngagementData.engagement_type });

                this.sendRequest({
                    method: 'OPTIONS',
                    endpoint: optionsEndpoint
                })
                    .then(this._handleOptionsResponse.bind(this))
                    .catch(this._handleOptionsError.bind(this));

                const attachmentsEndpoint = this.getEndpoint('attachments', { id: this.updatedEngagementData.id });
                this.sendRequest({
                    method: 'OPTIONS',
                    endpoint: attachmentsEndpoint
                })
                    .then(this._handleDataOptionsResponse('attachments', 'attachments'))
                    .catch(this._handleDataOptionsResponse('attachments', 'attachments'));

                const reportAttachmentsEndpoint = this.getEndpoint('reportAttachments', {id: this.updatedEngagementData.id});
                this.sendRequest({
                    method: 'OPTIONS',
                    endpoint: reportAttachmentsEndpoint
                })
                    .then(this._handleDataOptionsResponse('report_attachments','reportAttachments'))
                    .catch(this._handleDataOptionsResponse('report_attachments','reportAttachments'));

                let apBaseUrl = this.getEndpoint('engagementInfo', {id: this.updatedEngagementData.id, type: 'engagements'}).url;
                this.sendRequest({
                    method: 'OPTIONS',
                    endpoint: {
                        url: `${apBaseUrl}action-points/`
                    }
                })
                    .then(this._handleDataOptionsResponse('ap','apOptions'))
                    .catch(this._handleDataOptionsResponse('ap','apOptions'));
            },

            _handleError: function (event, error) {
                if (this.requestOptions.method === 'PATCH') {
                    this.fire('global-loading', {type: 'update-engagement'});
                } else if (this.requestOptions.method === 'POST' && ~this.actionUrl.indexOf('submit')) {
                    this.fire('global-loading', {type: 'submit-engagement'});
                } else if (this.requestOptions.method === 'POST' && ~this.actionUrl.indexOf('finalize')) {
                    this.fire('global-loading', {type: 'finalize-engagement'});
                } else if (this.requestOptions.method === 'POST' && ~this.actionUrl.indexOf('cancel')) {
                    this.fire('global-loading', {type: 'cancel-engagement'});
                }

                this.actionUrl = '';

                let responseData = error && error.request && error.request.detail &&
                                    error.request.detail.request && error.request.detail.request.xhr;

                let {status, response} = responseData || {};
                if (typeof response === 'string') {
                    try {
                        response = JSON.parse(response);
                    } catch (e) {
                        response = {};
                    }
                }

                if (status === 400) {
                    this.set('errorObject', response);
                } else if(status === 413) {
                    this.errorObject = {};
                    this.fire('toast', {text: `Error: Exceeded the maximum size of uploaded file.`});
                } else {
                    this.errorObject = {};
                    this.fire('toast', {text: 'Can not save engagement data. Please try again later!'});
                }

                this.fire('engagement-updated');

                if (this.quietAdding) {
                    this.quietAdding = false;
                }
            },

            _handleOptionsError: function() {
                this.optionsUrl = '';
                this.basePermissionPath = 'not_found';
                this.finishResponse(this.lastData);
                this.fire('toast', {text: 'Can not update permissions data. Please reload the page!'});
            },

            _engagementChanged: function(engagement) {
                //return if no data changed
                if (!engagement) { return; }

                if (engagement.submit && !this.actionUrl) {
                    //Prepare submit request. Save submit url, update engagement data at first
                    let url = this.getEndpoint('engagementInfo', {type: engagement.engagement_type, id: engagement.id}).url;
                    // this.actionUrl = url + engagement.submit;
                    // this.requestOptions.method = 'PATCH';
                    this.set('requestOptions', {
                        method: 'PATCH',
                        endpoint: {
                            url: url + engagement.submit
                        },
                        body: engagement.data
                    });
                    this._saveEngagement();
                } else if (this.actionUrl && ~this.actionUrl.indexOf('submit')) {
                    //Finish data updating, run submitting if submit url has been saved
                    this.fire('engagement-updated', {success: true, data: engagement});

                    this.fire('global-loading', {type: 'submit-engagement', active: true, message: 'Submitting engagement...'});
                    this.fire('global-loading', {type: 'update-engagement'});
                    // this.url = this.actionUrl;
                    // this.requestOptions.method = 'POST';
                    this.set('requestOptions', {
                        method: 'POST',
                        endpoint: {
                            url: this.actionUrl
                        },
                        body: this.postData
                    });

                    this._performUpdate()

                } else if (engagement.finalize) {
                    //Run finalizing
                    this.fire('global-loading', {type: 'finalize-engagement', active: true, message: 'Finalizing engagement...'});
                    let url = this.getEndpoint('engagementInfo', {type: engagement.engagement_type, id: engagement.id}).url + engagement.finalize;
                    // this.requestOptions.method = 'POST';
                    // this.url = url;

                    this.actionUrl = url;
                    this.postData = engagement.data;
                    this.set('requestOptions', {
                        method: 'POST',
                        endpoint: {
                            url
                        },
                        body: this.postData
                    });
                    this._performUpdate();
                } else if (engagement.cancel) {
                    //Run finalizing
                    this.fire('global-loading', {type: 'cancel-engagement', active: true, message: 'Canceling engagement...'});
                    let url = this.getEndpoint('engagementInfo', {type: engagement.engagement_type, id: engagement.id}).url + engagement.cancel;
                    this.actionUrl = url;
                    this.postData = engagement.data;
                    this.set('requestOptions', {
                        method: 'POST',
                        endpoint: {
                            url
                        },
                        body: this.postData
                    });
                    this._performUpdate();
                } else {
                    //Simple engagement data updating
                    let url = this.getEndpoint('engagementInfo', {type: engagement.engagement_type, id: engagement.id}).url;
                    this.actionUrl = '';
                    this.set('requestOptions', {
                        method: 'PATCH',
                        endpoint: {
                            url
                        },
                        body: engagement.data
                    });
                    this._saveEngagement();
                }

            },

            _saveEngagement: function() {
                if (!this.quietAdding) {
                    this.fire('global-loading', {type: 'update-engagement', active: true, message: 'Updating engagement data...'});
                }
               this._performUpdate();
            },

            _performUpdate(){
                this.sendRequest(this.requestOptions)
                    .then(this._handleResponse.bind(this))
                    .catch(this._handleError.bind(this));
            }


        });
    </script>
</dom-module>
