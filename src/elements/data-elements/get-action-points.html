<!--import [polymer, etools-ajax/etools-ajax-request-behavior, lodash]-->
<!--import [etools-app-config, permission-controller]-->

<dom-module id="get-action-points">
    <template>
    </template>

    <script>
        Polymer({
            is: 'get-action-points',

            behaviors: [
                etoolsAppConfig.globals,
                APBehaviors.PermissionController,
                EtoolsAjaxRequestBehavior
            ],

            properties: {
                engagementId: {
                    type: Number,
                    notify: true,
                    observer: '_engagementIdChanged'
                },
                actionPoints: {
                    type: Array,
                    notify: true
                }

            },

            _handleResponse: function (data) {
                this.actionPoints = data.length && data || [];
                this.fire('ap-loaded', {success: true});
            },

            _handleError: function () {
                this.fire('ap-loaded');
            },

            _engagementIdChanged: function(engagementId) {
                if (!engagementId) { return; }
                let apBaseUrl = this.getEndpoint('engagementInfo', {id: engagementId, type: 'engagements'}).url;
                let url = `${apBaseUrl}action-points/?page_size=all`;
                this._getActionPoints(url);
            },

            _getActionPoints: function(url) {
                const requestOptions = {
                    endpoint: {
                        url,
                    }
                };
                
                this.sendRequest(requestOptions)
                    .then(this._handleResponse.bind(this))
                    .catch(this._handleError.bind(this))
            }
        });
    </script>
</dom-module>
