<!--import [polymer, etools-ajax/etools-ajax-request-behavior]-->
<!--import [etools-app-config]-->

<dom-module id="check-user-existence">
    <template>
    </template>

    <script>
        Polymer({
            is: 'check-user-existence',

            behaviors: [
                etoolsAppConfig.globals,
                EtoolsAjaxRequestBehavior
            ],

            properties: {
                email: {
                    type: String,
                    notify: true,
                    observer: '_emailChanged'
                },
                emailChecking: {
                    type: Boolean,
                    value: false,
                    notify: true
                },
                errors: {
                    type: String,
                    notify: true
                },
                unicefUsersAllowed: {
                    type: Boolean,
                    notify: true
                },
                editedItem: {
                    type: Object,
                    notify: true
                }
            },

            _emailChanged: function(email) {
                if (!email) { return; }
                if (isNaN(+this.organisationId)) { return; }

                this.emailChecking = true;
                let url = this.getEndpoint('userExistence', {
                    email: encodeURIComponent(email),
                    id: this.organisationId
                }).url;

                this.sendRequest({
                    endpoint: {url}
                }).then(resp => {
                   this._handleResponse(resp);
                }).catch(err => {
                    this._handleError(err);
                });

                this.email = null;
            },

            _handleResponse: function(details = []) {
                const user = _.get(details, '0');
                let firmId = user.auditor_firm,
                    userIsNotDeleted = firmId === this.organisationId && !user.hidden,
                    alreadyExists = firmId && (firmId !== this.organisationId || userIsNotDeleted);
                if (alreadyExists || (details.length && !this.unicefUsersAllowed && userIsNotDeleted)) {
                    //if user exists in other firm, or in current but is not deleted, or user exists and unicefUsersAllowed is false
                    this._setError(`This user is already assigned to firm : ${user.auditor_firm_description}`);
                    let email = _.get(this, 'editedItem.user.email'),
                        hasAccess = false;
                    this.editedItem = {user: {email}, hasAccess};
                }
                if (firmId === this.organisationId) {
                    //if user was deleted from current organization
                    let user = details[0];
                    user.is_active = true;
                    this.editedItem = {
                        id: user.staff_member_id,
                        hidden: false,
                        hasAccess: true,
                        user: _.omit(user, ['id', 'auditor_firm', 'staff_member_id', 'hidden'])
                    };
                } else if (details.length) {
                    //if user exists but doesn't belong to any auditor_firm
                    let user = details[0],
                        user_pk = user.id;

                    this.editedItem = {
                        hasAccess: true,
                        user: _.omit(user, ['id', 'auditor_firm']),
                        user_pk
                    };
                } else if (this.unicefUsersAllowed) {
                    //if is new user and unicefUsersAllowed
                    this._setError(`You can't add new user to this firm.`);
                    this.editedItem = _.pick(this.editedItem, ['user', 'hasAccess']);
                } else {
                    //if is new user
                    this.editedItem = _.pick(this.editedItem, ['user', 'hasAccess']);
                }

                this.emailChecking = false;
            },

            _handleError: function() {
                this._setError(`Can't get Email data!`);
                this.emailChecking = false;
            },

            _setError: function(error) {
                if (!this.errors) { this.set('errors', {}); }
                if (!this.errors.user) { this.set('errors.user', {}); }
                if (!this.errors.user.email) { this.set('errors.user.email', error); }
            }
        });
    </script>
</dom-module>
