<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>

    <!--import [engagements-list-view, lodash]-->
</head>
<body>

<test-fixture id="engagements-list-view-fixture">
    <template>
        <engagements-list-view></engagements-list-view>
    </template>
</test-fixture>

<script>
    describe('<engagements-list-view>', function () {
        let myEl;
        let filters = [
            {
                name: 'auditor',
                query: 'agreement__auditor_firm',
                optionValue: 'id',
                optionLabel: 'name',
                selection: []
            },
            {
                name: 'engagement type',
                query: 'engagement_type',
                hideSearch: true,
                optionValue: 'value',
                optionLabel: 'label',
                selection: [{
                    label: 'Audit',
                    value: 'audit'
                }, {
                    label: 'Micro Assessment',
                    value: 'ma'
                }, {
                    label: 'Spot Check',
                    value: 'sc'
                }]
            },
            {
                name: 'partner',
                query: 'partner',
                optionValue: 'id',
                optionLabel: 'name',
                selection: []
            },
            {
                name: 'status',
                query: 'status',
                hideSearch: true,
                optionValue: 'value',
                optionLabel: 'label',
                selection: [
                    {
                        label: 'Partner was Contacted',
                        value: 'partner_contacted'
                    },
                    {
                        label: 'Field Visit',
                        value: 'field_visit'
                    },
                    {
                        label: 'Draft Report Issued To IP',
                        value: 'draft_issued_to_unicef'
                    },
                    {
                        label: 'Comments Received By IP',
                        value: 'comments_received_by_partner'
                    },
                    {
                        label: 'Draft Report Issued To UNICEF',
                        value: 'draft_issued_to_partner'
                    },
                    {
                        label: 'Comments Received By UNICEF',
                        value: 'comments_received_by_unicef'
                    },
                    {
                        label: 'Report Submitted',
                        value: 'report_submitted'
                    },
                    {
                        label: 'Final Report',
                        value: 'final'
                    },
                    {
                        label: 'Cancelled',
                        value: 'cancelled'
                    }
                ]
            }
        ];

        let listHeadings = [{
            'size': 15,
            'label': 'Purchase Order #',
            'name': 'unique_id',
            'link': '*engagement_type*/*data_id*/overview',
            'ordered': false,
            'path': 'agreement.order_number'
        }, {
            'size': 20,
            'label': 'Partner Name',
            'name': 'partner__name',
            'ordered': false,
            'path': 'partner.name'
        }, {
            'size': 20,
            'label': 'Auditor',
            'name': 'agreement__auditor_firm__name',
            'ordered': false,
            'path': 'agreement.auditor_firm.name'
        }, {
            'size': 15,
            'label': 'Engagement Type',
            'name': 'type',
            'ordered': false
        }, {
            'size': 30,
            'label': 'Status',
            'name': 'status',
            'ordered': false,
            'additional': {
                'type': 'date',
                'path': 'status_date'
            }
        }];

        beforeEach(function () {
            myEl = fixture('engagements-list-view-fixture');
        });

        describe('method _showAddButton()', function () {
            it('returns true if actionAllowed method returns true and first argument is true', function () {
                let spy = sinon.stub(myEl, 'actionAllowed');
                spy.withArgs('new_engagement', 'create').returns(true);

                assert.isTrue(myEl._showAddButton(true));
                assert.isTrue(spy.calledOnce);
                assert.isTrue(spy.calledWithExactly('new_engagement', 'create'));
            });

            it('returns false if actionAllowed method returns false or first argument is false', function () {
                let spy = sinon.stub(myEl, 'actionAllowed');
                spy.withArgs('new_engagement', 'create').returns(true);

                assert.isFalse(myEl._showAddButton(false));

                spy.withArgs('new_engagement', 'create').returns(false);
                assert.isFalse(myEl._showAddButton(true));
            });
        });

        describe('method _getFilterIndex(query)', function () {
            it('returns -1 if filters is not Array', function () {
                assert.equal(myEl._getFilterIndex(null), -1);
            });

            it('returns -1 if filter with such query not found', function () {
                assert.equal(myEl._getFilterIndex('no_such_query'), -1);
            });

            it('returns filter index', function () {
                let query = filters[1].query;
                assert.equal(myEl._getFilterIndex(query), 1);
            });
        });

        describe('method setFilterSelection(filterIndex, data)', function () {
            beforeEach(function () {
                myEl.filters = _.cloneDeep(filters);
            });
            
            it('should set filter selection data by filterIndex', function () {
                let auditorsFilterIndex = myEl._getFilterIndex('agreement__auditor_firm');
                let auditors = [{}, {}];
                myEl.filters[auditorsFilterIndex].selection = null;

                assert.isNull(myEl.filters[auditorsFilterIndex].selection, auditors);
                assert.isTrue(myEl.setFilterSelection(auditorsFilterIndex, auditors));
                assert.deepEqual(myEl.filters[auditorsFilterIndex].selection, auditors);
            });

            it('shouldn\'t set filter selection when filterIndex is undefined or -1', function () {
                assert.isUndefined(myEl.setFilterSelection(-1, []));
                assert.isUndefined(myEl.setFilterSelection(undefined, []));
            });
        });
    });
</script>

</body>
</html>