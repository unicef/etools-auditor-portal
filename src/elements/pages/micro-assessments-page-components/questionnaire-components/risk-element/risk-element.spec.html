<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>

    <!--import [risk-element]-->
</head>
<body>

<test-fixture id="element-fixture">
    <template>
        <risk-element id="element"></risk-element>
    </template>
</test-fixture>


<script>
    describe('<risk-element>', function () {
        var myEl;

        beforeEach(function () {
            myEl = fixture('element-fixture');
        });

        it('method _setIndex return ornder number', function() {
            assert.equal(myEl._setIndex(2), 3);
            assert.equal(myEl._setIndex(0), 1);
            assert.equal(myEl._setIndex(123), 124);
        });

/*        describe('method _setRiskValue', function() {
            it('return undefined if no value provided', function() {
                assert.isUndefined(myEl._setRiskValue());
            });

            it('return option object if index value provided', function() {
                assert.equal(myEl._setRiskValue(0).label, myEl.riskOptions[0].label);
                assert.equal(myEl._setRiskValue(3).label, myEl.riskOptions[3].label);
            });

            it('return value if it is object', function() {
                var test = {label: 'test'};
                assert.equal(myEl._setRiskValue(test), test);
            })
        });*/

        describe('method _setValues', function() {
            it('return undefined if no value provided or value is null', function() {
                assert.isUndefined(myEl._setValues());
                assert.isUndefined(myEl._setValues(null));
            });

            it('throws if argument is not a valid JSON', function() {
                var first = myEl._setValues.bind(myEl, "test"),
                        second = myEl._setValues.bind(myEl, {foo: 'bar'});
                assert.throws(first);
                assert.throws(second);
            });

            it('set corresponding properties if argument is valid', function() {
                var json = '{"comments": "test", "answer": "test"}';

                assert.isTrue(myEl._setValues(json));
                assert.equal(myEl.comments, 'test');
                assert.isTrue(myEl.answer_test);
            })
        });

        describe('methods setYes, setNo, setNa', function() {
            it('calls setAnswer if new Value is true', function() {
                var spy = sinon.spy(myEl, 'setAnswer');

                myEl.setYes(true);
                assert.isTrue(myEl.setAnswer.called);
                spy.reset();

                assert.isFalse(myEl.setAnswer.called);
                myEl.setNo(true);
                assert.isTrue(myEl.setAnswer.called);
                spy.reset();

                assert.isFalse(myEl.setAnswer.called);
                myEl.setNa(true);
                assert.isTrue(myEl.setAnswer.called);
            });

            it('calls setAnswer if new Value is true old Value is false and checkRadio return true', function() {
                var spy = sinon.stub(myEl, 'setAnswer').returns(true);
                sinon.stub(myEl, 'checkRadio').returns(true);

                myEl.setYes(false, true);
                assert.isTrue(myEl.setAnswer.called);
                spy.reset();

                assert.isFalse(myEl.setAnswer.called);
                myEl.setNo(false, true);
                assert.isTrue(myEl.setAnswer.called);
                spy.reset();

                assert.isFalse(myEl.setAnswer.called);
                myEl.setNa(false, true);
                assert.isTrue(myEl.setAnswer.called);

                myEl.setAnswer.restore();
                myEl.checkRadio.restore();
            });

            it('not calls setAnswer in other cases', function() {
                var spy = sinon.stub(myEl, 'setAnswer').returns(true);
                sinon.stub(myEl, 'checkRadio').returns(false);

                myEl.setYes(false, true);
                assert.isFalse(myEl.setAnswer.called);

                myEl.setNo(false, false);
                assert.isFalse(myEl.setAnswer.called);

                myEl.setNa(false, false);
                assert.isFalse(myEl.setAnswer.called);

                myEl.setAnswer.restore();
                myEl.checkRadio.restore();
            });
        });

        it('method setAnswer set corresponding answer property to true', function() {
            myEl.setAnswer('yes');
            assert.isTrue(myEl.answer_yes);
            assert.isFalse(myEl.answer_no);
            assert.isFalse(myEl.answer_na);

            myEl.setAnswer('no');
            assert.isFalse(myEl.answer_yes);
            assert.isTrue(myEl.answer_no);
            assert.isFalse(myEl.answer_na);

            myEl.setAnswer('na');
            assert.isFalse(myEl.answer_yes);
            assert.isFalse(myEl.answer_no);
            assert.isTrue(myEl.answer_na);
        });

        it('method setAnswer calls setExtra method', function() {
            sinon.spy(myEl, 'setExtra');

            myEl.setAnswer();

            assert.isTrue(myEl.setExtra.called);
            myEl.setExtra.restore();
        });

        it('method checkRadio return true if other answers are false', function() {
            myEl.answer_no = false;
            myEl.answer_na = false;
            myEl.answer_yes = true;

            assert.isTrue(myEl.checkRadio('yes'));

            myEl.answer_na = true;

            assert.isTrue(myEl.checkRadio('na'));
        });

        describe('method _setRequired', function() {
            it('return \'required\' if edit mode is true', function() {
                assert.equal(myEl._setRequired(true), 'required');
            });
            it('return empty string if edit mode is false', function() {
                assert.equal(myEl._setRequired(false), '');
            })
        });

        it('method _resetFieldError set event target invallid property to false', function() {
            var event = {target: {invalid: true}};
            myEl._resetFieldError(event);
            assert.isFalse(event.target.invalid);
        });

        describe('method _setRiskAnswer', function() {
            it('return yes if answer_yes property is true', function() {
                myEl.answer_yes = true;
                assert.equal(myEl._setRiskAnswer(), 'yes');
            });

            it('return no if answer_no property is true', function() {
                myEl.answer_no = true;
                assert.equal(myEl._setRiskAnswer(), 'no');
            });

            it('return na if answer_na property is true', function() {
                myEl.answer_na = true;
                assert.equal(myEl._setRiskAnswer(), 'na');
            });
        });

        it('method setExtra set extra property to element as JSON', function() {
            myEl.blueprint = {};
            myEl.answer_na = true;
            myEl.comments = 'test';
            myEl.setExtra();

            assert.equal(myEl.extra, '{"comments":"test","answer":"na"}');
        });

        it('method _setQuestionHeader set header content', function(done) {
            var content = 'Test test';
            flush(function() {
                myEl._setQuestionHeader(content);
                assert.equal(myEl.$.header.innerHTML, content);
                done();
            });
        });

        describe('method getData', function() {
            it('return undefined if risk no value selected', function() {
                assert.isUndefined(myEl.getData());
            });

            it('return risk data copy if risk value is selected', function(done) {
                flush(function() {
                    myEl.blueprint = {
                        id: 0,
                        value: 2
                    };

                    var data = myEl.getData();
                    assert.equal(data.id, 0);
                    assert.equal(data.value, 2);
                    done();
                });
            });

            it('return undefined if value is not changed', function(done) {
                flush(function() {
                    myEl.blueprint = {
                        id: 0,
//                        value: 2,
                        extra: myEl.extra
                    };
                    assert.isUndefined(myEl.getData());
                    done();
                });
            });

            it('return data if value is not changed and extra is changed', function(done) {
                flush(function() {
                    myEl.blueprint = {
                        id: 0,
                        value: 2
                    };

                    assert.isDefined(myEl.extra);

                    var data = myEl.getData();
                    assert.equal(data.id, 0);
                    assert.equal(data.value, 2);
                    assert.equal(data.extra, myEl.extra);
                    done();
                });
            });
        });

        it('method validate run validateForSave method if first argument is provided', function() {
            sinon.spy(myEl, 'validateForSave');
            myEl.validate('forSave');
            assert.isTrue(myEl.validateForSave.called);
        });

        it('method validate validate input and return validation value if first argument is not provided', function(done) {
            flush(function() {
                sinon.spy(myEl, 'validateForSave');
                myEl.$.riskAssessmentInput.validate = sinon.stub().returns(true);

                assert.isTrue(myEl.validate());
                assert.isFalse(myEl.validateForSave.called);
                assert.isTrue(myEl.$.riskAssessmentInput.validate.called);

                myEl.$.riskAssessmentInput.validate.returns(false);
                assert.isFalse(myEl.validate());
                done();
            });
        });

        describe('method validateForSave', function() {
            it('return true and set riskAssessmentInvalid to false if there is no comments and answer_na property is true', function() {
                myEl.comments = '';
                myEl.answer_na = true;
                myEl.riskAssessmentInvalid = true;

                assert.isTrue(myEl.riskAssessmentInvalid);
                assert.isTrue(myEl.validateForSave());
                assert.isFalse(myEl.riskAssessmentInvalid);
            });

            it('validate input and return validation value in other cases', function(done) {
                flush(function() {
                    myEl.$.riskAssessmentInput.validate = sinon.stub().returns(true);
                    myEl.comments = 'test';

                    assert.isTrue(myEl.validateForSave());
                    assert.isTrue(myEl.$.riskAssessmentInput.validate.called);

                    myEl.$.riskAssessmentInput.validate.returns(false);
                    assert.isFalse(myEl.validateForSave());
                    done();
                });
            });
        });
    });
</script>

</body>
</html>