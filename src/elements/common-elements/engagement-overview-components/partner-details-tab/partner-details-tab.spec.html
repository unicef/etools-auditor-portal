<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

    <script src="../bower_components/webcomponentsjs/webcomponents-lite.js"></script>
    <script src="../bower_components/web-component-tester/browser.js"></script>

    <!--import [partner-details-tab]-->
</head>
<body>

<test-fixture id="element-fixture">
    <template>
        <partner-details-tab id="element"></partner-details-tab>
    </template>
</test-fixture>


<script>
    describe('<partner-details-tab>', function () {
        var myEl;

        beforeEach(function () {
            myEl = fixture('element-fixture');
        });

        it('method resetValidationErrors sets $.partner.invalid to false', function() {
            myEl.$.partner.invalid = true;
            myEl.resetValidationErrors();
            assert.isFalse(myEl.$.partner.invalid);
        });

        it('method _resetFieldError sets errors.partner and errors.active_pd equal to false', function() {
            sinon.spy(myEl, 'set');
            myEl._resetFieldError();
            assert.isTrue(myEl.set.calledTwice);
            assert.isTrue(myEl.set.calledWith('errors.active_pd', false));
            assert.isTrue(myEl.set.calledWith('errors.partner', false));
            myEl.set.restore();
        });

        it('method _partnerLoaded sets requestInProcess to false and calls validate method', function() {
            sinon.stub(myEl, 'validate');
            myEl.requestInProcess = true;

            myEl._partnerLoaded();

            assert.isFalse(myEl.requestInProcess);
            assert.isTrue(myEl.validate.called);

            myEl.validate.restore();
        });

        describe('method _engagementChanged', function() {
            it('calls set method if partner argument is not provided', function() {
                sinon.spy(myEl, 'set');
                myEl._engagementChanged();
                assert.isTrue(myEl.set.calledWith('partner', {}));
                assert.isTrue(myEl.set.calledWith('activePd', null));
                myEl.set.restore();
            });

            it('calls _requestPartner method with partner.id as second argument', function() {
                sinon.stub(myEl, '_requestPartner');
                var partner = {id: 2};
                myEl._engagementChanged(partner);
                assert.isTrue(myEl._requestPartner.calledWith(null, partner.id));
                myEl._requestPartner.restore();
            });
        });

        describe('method _setReadonlyClass', function() {
            it('returns disabled-as-readonly if isReadOnly method returns true', function() {
                sinon.stub(myEl, 'isReadOnly').returns(true);
                assert.equal(myEl._setReadonlyClass(), 'disabled-as-readonly');
                myEl.isReadOnly.restore();
            });

            it('returns readonly if inProcess argument is true or empty string', function() {
                sinon.stub(myEl, 'isReadOnly').returns(false);
                assert.equal(myEl._setReadonlyClass(true), 'readonly');
                assert.equal(myEl._setReadonlyClass(), '');
                myEl.isReadOnly.restore();
            });
        });

        describe('method getPartnerData', function () {
            it('returns null if originalData.partner.id === engagement.partner.id', function() {
                myEl.originalData = {partner: {id: 666}};
                myEl.engagement = {partner: {id: 666}};
                assert.isNull(myEl.getPartnerData());
            });

            it('returns object with partner id and active_pd if originalData.partner.id !== engagement.partner.id', function() {
                let returnedData = {
                    partner: 9,
                    active_pd: [1, 2, 3]
                };
                myEl.originalData = {partner: {id: 666}};
                myEl.engagement = {partner: {id: 9}};
                myEl.activePd = [1, 2, 3];

                assert.deepEqual(myEl.getPartnerData(), returnedData);
            });

            it('returns object with partner id and active_pd if originalData is not defined', function() {
                let returnedData = {
                    partner: 9,
                    active_pd: [1, 2, 3]
                };
                myEl.originalData = null;
                myEl.engagement = {partner: {id: 9}};
                myEl.activePd = [1, 2, 3];

                assert.deepEqual(myEl.getPartnerData(), returnedData);
            });
        });

        describe('method _setActivePd()', function () {
            it('returns when method isReadOnly() returns false', function () {
                sinon.stub(myEl, 'isReadOnly').returns(false);
                myEl.activePd = null;

                assert.isUndefined(myEl._setActivePd());
            });

            it('returns when activePd is defined', function () {
                sinon.stub(myEl, 'isReadOnly').returns(true);
                myEl.activePd = [];

                assert.isUndefined(myEl._setActivePd());
            });

            it('returns if isReadOnly() returns true, activePd is not defined, but engagement is not defined', function () {
                sinon.stub(myEl, 'isReadOnly').returns(true);
                myEl.activePd = null;
                myEl.engagement = null;

                assert.isUndefined(myEl._setActivePd());
            });

            it('returns if isReadOnly() returns true, activePd is not defined, but engagement.active_pd is not defined', function () {
                sinon.stub(myEl, 'isReadOnly').returns(true);
                myEl.activePd = null;
                myEl.engagement = {active_pd: null};

                assert.isUndefined(myEl._setActivePd());
            });

            it('sets activePd property and returns true', function () {
                sinon.stub(myEl, 'isReadOnly').returns(true);
                myEl.activePd = null;
                myEl.engagement = {active_pd: [{id: 1}, {id: 2}, {id: 3}]};

                assert.isTrue(myEl._setActivePd());
                assert.deepEqual(myEl.activePd, [1, 2, 3]);
            });
        });

        describe('method _requestPartner', function() {
            it('returns if requestInProcess is true', function() {
                sinon.spy(myEl, 'set');
                myEl.requestInProcess = true;
                myEl._requestPartner();
                assert.isFalse(myEl.set.called);
                myEl.set.restore();
            });

            it('returns if partnerId is not found', function() {
                sinon.stub(myEl, 'set');
                sinon.stub(myEl, 'isReadOnly').returns(true);
                myEl.requestInProcess = false;
                myEl.engagement = {};

                myEl._requestPartner();
                assert.isTrue(myEl.set.called);
                assert.isFalse(myEl.isReadOnly.called);

                myEl._requestPartner(null, 12);
                assert.isTrue(myEl.isReadOnly.called);
                myEl.isReadOnly.reset();

                myEl._requestPartner({detail: {selectedValues: {id: 12}}});
                assert.isTrue(myEl.isReadOnly.called);

                myEl.set.restore();
                myEl.isReadOnly.restore();
            });

            it('sets partner equal to engagement data if isReadOnly returns true, sets partner.interventions', function() {
                sinon.stub(myEl, 'isReadOnly').returns(true);
                var partner = {
                    id: 1,
                    foo: 'bar'
                };
                myEl.engagement = {partner: partner, active_pd: [{id: 1}, {id: 2}]};
                myEl._requestPartner(null, 12);
                assert.equal(myEl.partner, partner);
                assert.deepEqual(myEl.partner.interventions, myEl.engagement.active_pd);
            });

            it('returns true, sets requestInProcess to true, partnerId if isReadOnly returns false', function() {
                sinon.stub(myEl, 'isReadOnly').returns(false);
                assert.isTrue(myEl._requestPartner(null, 12));
                assert.isTrue(myEl.requestInProcess);
            })
        });

        describe('method isPdReadonly(basePermissionPath, requestInProcess, partner)', function () {
            it('returns true when method isReadOnly() returns true', function () {
                sinon.stub(myEl, 'isReadOnly').returns(true);
                assert.isTrue(myEl.isPdReadonly('path', true, {id: 1}));
            });

            it('returns true when partner.id is not defined', function () {
                sinon.stub(myEl, 'isReadOnly').returns(false);
                assert.isTrue(myEl.isPdReadonly('path', false, {id: undefined}));
            });

            it('returns false when method isReadOnly() returns false and partner.id is defined', function () {
                sinon.stub(myEl, 'isReadOnly').returns(false);
                assert.isFalse(myEl.isPdReadonly('path', false, {id: 1}));
            });
        });
    });
</script>

</body>
</html>