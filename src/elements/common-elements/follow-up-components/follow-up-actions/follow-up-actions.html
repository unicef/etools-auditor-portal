<!--import [polymer, paper-icon-button, paper-input, etools-checkable-input, paper-icon-button, etools-content-panel,
            iron-icons, lodash, paper-tooltip, paper-input/paper-textarea, paper-button, etools-ajax]-->

<!--import [tab-inputs-styles, tab-layout-styles, module-styles, permission-controller, list-header, list-element, dialog-element, table-elements-behavior,
            textarea-max-rows-behavior, get-action-points, update-action-points]-->

<dom-module id="follow-up-actions">
    <template>
        <style include="tab-inputs-styles tab-layout-styles module-styles"></style>
        <!-- inject styles './follow-up-actions.scss'-->

        <etools-ajax
                url="[[apOptionUrl]]"
                method="OPTIONS"
                on-success="_handleOptionResponse"
                on-fail="_handleOptionResponse">
        </etools-ajax>
        <get-action-points engagement-id="[[engagementId]]" action-points="{{dataItems}}"></get-action-points>
        <update-action-points engagement-id="[[engagementId]]"
                              request-in-process="{{requestInProcess}}"
                              request-data="{{requestData}}"
                              errors="{{errors}}"
                              action-points="{{dataItems}}"></update-action-points>

        <etools-content-panel panel-title="UNICEF Follow-Up Actions">
            <div slot="panel-btns">
                <div hidden$="[[!canBeChanged]]">
                    <paper-icon-button
                            class="panel-button"
                            on-tap="_openAddDialog"
                            icon="add-box">
                    </paper-icon-button>
                    <paper-tooltip offset="0">Add</paper-tooltip>
                </div>
            </div>

            <list-header no-ordered data="[[columns]]" base-permission-path="[[basePermissionPath]]"></list-header>

            <template is="dom-repeat" items="[[dataItems]]" filter="_showItems">
                <list-element
                        class="list-element"
                        data="[[item]]"
                        base-permission-path="[[basePermissionPath]]"
                        headings="[[columns]]"
                        details="[[details]]"
                        has-collapse
                        no-animation>
                    <div slot="checkbox" class="checkbox">
                        <paper-checkbox
                                disabled="disabled"
                                checked="{{item.high_priority}}"
                                label="">
                        </paper-checkbox>
                    </div>
                    <div slot="hover" class="edit-icon-slot" hidden$="[[!canBeEdited(item.status)]]">
                        <paper-icon-button icon="icons:create" class="edit-icon" on-tap="_openEditDialog"></paper-icon-button>
                    </div>
                </list-element>
            </template>

            <template is="dom-if" if="[[!dataItems.length]]">
                <list-element
                        class="list-element"
                        data="[[itemModel]]"
                        headings="[[columns]]"
                        no-animation>
                    <div slot="checkbox" class="checkbox">
                        <span>â€“</span>
                    </div>
                </list-element>
            </template>
        </etools-content-panel>

        <dialog-element
                opened="{{dialogOpened}}"
                dialog-title="[[dialogTitle]]"
                confirm-btn-text="[[confirmBtnText]]"
                hide-confirm-btn="[[!confirmBtnText]]"
                request-in-process="{{requestInProcess}}">
            <div class="row-h repeatable-item-container" without-line>
                <div class="repeatable-item-content">

                    <div class="row-h group">
                        <div class="input-container input-container-l">
                            <!-- Due Date -->
                            <paper-input
                                    id="deadlineAction"
                                    class$="disabled-as-readonly validate-input [[_setRequired('due_date', editedApBase)]]"
                                    value="[[prettyDate(editedItem.due_date)]]"
                                    label="[[getLabel('due_date', editedApBase)]]"
                                    placeholder="[[getPlaceholderText('due_date', editedApBase)]]"
                                    data-selector="deadlineActionSelector"
                                    required$="[[_setRequired('due_date', editedApBase)]]"
                                    disabled$="{{isReadOnly('due_date', editedApBase, requestInProcess)}}"
                                    readonly$="{{isReadOnly('due_date', editedApBase, requestInProcess)}}"
                                    invalid="{{errors.due_date}}"
                                    error-message="{{errors.due_date}}"
                                    on-focus="_resetFieldError"
                                    on-tap="_resetFieldError"
                                    on-down="openDatePicker">
                                <etools-datepicker
                                        id="deadlineActionSelector"
                                        modal="[[datepickerModal]]"
                                        prefix
                                        format="YYYY-MM-DD"
                                        date="[[prepareDate(editedItem.due_date)]]"
                                        pretty-date="{{editedItem.due_date}}"
                                        no-init
                                        show-clear-btn>
                                </etools-datepicker>
                            </paper-input>
                        </div>
                    </div>

                    <div class="row-h group">
                        <div class="input-container input-container-l">
                            <!-- Assigned To -->
                            <etools-searchable-multiselection-menu
                                    class$="disabled-as-readonly validate-input [[_setRequired('assigned_to', editedApBase)]] fua-person"
                                    value="{{editedItem.assigned_to}}"
                                    label="[[getLabel('assigned_to', editedApBase)]]"
                                    placeholder="[[getPlaceholderText('assigned_to', editedApBase)]]"
                                    options="[[users]]"
                                    custom-object-options
                                    option-label="full_name"
                                    option-value="id"
                                    update-selected
                                    required$="[[_setRequired('assigned_to', editedApBase)]]"
                                    disabled$="{{isReadOnly('assigned_to', editedApBase, requestInProcess)}}"
                                    readonly$="{{isReadOnly('assigned_to', editedApBase, requestInProcess)}}"
                                    invalid="{{errors.assigned_to}}"
                                    error-message="{{errors.assigned_to}}"
                                    on-focus="_resetFieldError"
                                    on-tap="_resetFieldError"
                                    no-title-attr>
                            </etools-searchable-multiselection-menu>
                        </div>
                    </div>

                    <div class="row-h group">
                        <div class="input-container input-container-l">
                            <!-- Description -->
                            <paper-textarea
                                    class$="validate-input {{_setRequired('description', editedApBase)}}"
                                    value="{{editedItem.description}}"
                                    allowed-pattern="[\d\s]"
                                    label="[[getLabel('description', editedApBase)]]"
                                    placeholder="[[getPlaceholderText('description', editedApBase)]]"
                                    required="{{_setRequired('description', editedApBase)}}"
                                    disabled="{{isReadOnly('description', editedApBase, requestInProcess)}}"
                                    readonly$="{{isReadOnly('description', editedApBase, requestInProcess)}}"
                                    max-rows="4"
                                    invalid="{{errors.description}}"
                                    error-message="{{errors.description}}"
                                    on-focus="_resetFieldError"
                                    on-tap="_resetFieldError">
                            </paper-textarea>
                        </div>
                    </div>

                    <div class="row-h group">
                        <div class="input-container input-container-l">
                            <!-- Offices -->
                            <etools-searchable-multiselection-menu
                                    class$="disabled-as-readonly validate-input [[_setRequired('office', editedApBase)]] fua-person"
                                    value="{{editedItem.office}}"
                                    label="[[getLabel('office', editedApBase)]]"
                                    placeholder="[[getPlaceholderText('office', editedApBase)]]"
                                    options="[[offices]]"
                                    custom-object-options
                                    option-label="name"
                                    option-value="id"
                                    update-selected
                                    required$="[[_setRequired('office', editedApBase)]]"
                                    disabled$="{{isReadOnly('office', editedApBase, requestInProcess)}}"
                                    readonly$="{{isReadOnly('office', editedApBase, requestInProcess)}}"
                                    invalid="{{errors.office}}"
                                    error-message="{{errors.office}}"
                                    on-focus="_resetFieldError"
                                    on-tap="_resetFieldError"
                                    no-title-attr>
                            </etools-searchable-multiselection-menu>
                        </div>
                    </div>

                    <div class="row-h group">
                        <div class="input-container input-container-l">
                            <!-- Sections -->
                            <etools-searchable-multiselection-menu
                                    class$="disabled-as-readonly validate-input [[_setRequired('section', editedApBase)]] fua-person"
                                    value="{{editedItem.section}}"
                                    label="[[getLabel('section', editedApBase)]]"
                                    placeholder="[[getPlaceholderText('section', editedApBase)]]"
                                    options="[[sections]]"
                                    custom-object-options
                                    option-label="name"
                                    option-value="id"
                                    update-selected
                                    required$="[[_setRequired('section', editedApBase)]]"
                                    disabled$="{{isReadOnly('section', editedApBase, requestInProcess)}}"
                                    readonly$="{{isReadOnly('section', editedApBase, requestInProcess)}}"
                                    invalid="{{errors.section}}"
                                    error-message="{{errors.section}}"
                                    on-focus="_resetFieldError"
                                    on-tap="_resetFieldError"
                                    no-title-attr>
                            </etools-searchable-multiselection-menu>
                        </div>
                    </div>

                    <div class="row-h group">
                        <div class="input-container input-container-l">
                            <!-- Category -->
                            <etools-searchable-multiselection-menu
                                    class$="disabled-as-readonly validate-input [[_setRequired('category', editedApBase)]] fua-person"
                                    selected="{{editedItem.category}}"
                                    label="[[getLabel('category', editedApBase)]]"
                                    placeholder="[[getPlaceholderText('category', editedApBase)]]"
                                    options="[[categories]]"
                                    custom-object-options
                                    option-label="display_name"
                                    option-value="value"
                                    update-selected
                                    required$="[[_setRequired('category', editedApBase)]]"
                                    disabled$="{{isReadOnly('category', editedApBase, requestInProcess)}}"
                                    readonly$="{{isReadOnly('category', editedApBase, requestInProcess)}}"
                                    invalid="{{errors.category}}"
                                    error-message="{{errors.category}}"
                                    on-focus="_resetFieldError"
                                    on-tap="_resetFieldError"
                                    no-title-attr>
                            </etools-searchable-multiselection-menu>
                        </div>
                    </div>

                    <div class="row-h group">
                        <!-- High Priority -->
                        <div class="input-container checkbox-container">
                            <etools-checkable-input
                                    class="disabled-as-readonly"
                                    type="checkbox"
                                    label="[[getLabel('high_priority', editedApBase)]]"
                                    label-alignment="right"
                                    checked="{{editedItem.high_priority}}"
                                    disabled="{{isReadOnly('high_priority', editedApBase, requestInProcess)}}"
                                    readonly$="{{isReadOnly('high_priority', editedApBase, requestInProcess)}}">
                            </etools-checkable-input>
                        </div>

                        <template is="dom-if" if="[[actionAllowed(editedApBase, 'complete')]]">
                            <div class="input-container">
                                <paper-button on-tap="completeAP">Complete Action</paper-button>
                            </div>
                        </template>

                    </div>

                </div>
            </div>
        </dialog-element>
    </template>

    <!-- inject scripts './follow-up-actions.js'-->
</dom-module>