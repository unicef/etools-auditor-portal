<!--import [polymer, iron-icon, paper-icon-button, paper-toast,etools-ajax/etools-ajax-request-behavior, etools-content-panel, paper-tooltip]-->
<!--import [share-documents,engagement-behavior, simple-list-item, tab-inputs-styles, tab-layout-styles, module-styles, shared-styles, table-elements-behavior,
            common-methods-behavior, date-behavior,  get-attachments, update-attachments, error-handler-behavior]-->

<dom-module id="file-attachments-tab">
    <template>
        <style include="tab-inputs-styles tab-layout-styles iron-flex module-styles"></style>
        <!-- inject styles './file-attachments-tab.scss'-->

        <get-attachments base-id="[[baseId]]" attachments="{{dataItems}}" endpoint-name="[[endpointName]]"></get-attachments>
        <update-attachments
            base-id="[[baseId]]"
                attachments="{{dataItems}}"
                request-data="{{requestData}}"
                endpoint-name="[[endpointName]]"
                request-in-process="{{requestInProcess}}"
                errors="{{errors}}"></update-attachments>

        <etools-content-panel class="content-section clearfix" panel-title="[[tabTitle]]">
            <div slot="panel-btns">
                <div class="layout horizontal">
                    <div hidden$="[[isTabReadonly(basePermissionPath)]]">
                        <paper-icon-button class="panel-button"
                                           on-tap="_openShareDialog"
                                           icon="open-in-browser">
                        </paper-icon-button>
                        <paper-tooltip offset="0">Share Documents</paper-tooltip>
                    </div>
                    <div hidden$="[[isTabReadonly(basePermissionPath)]]">
                        <paper-icon-button class="panel-button"
                                           on-tap="_openAddDialog"
                                           icon="add-box">
                        </paper-icon-button>
                        <paper-tooltip offset="0">Add</paper-tooltip>
                    </div>
                </div>
            
            </div>
            <list-header
                    id="list-header"
                    no-additional
                    no-ordered
                    data="[[headings]]"
                    base-permission-path="[[basePermissionPath]]">
            </list-header>

            <template is="dom-repeat" items="[[dataItems]]" filter="_showItems">
                <simple-list-item>
                    <div class="row-data">
                        <span class$="[[_getClassFor('date')]]">[[prettyDate(item.created)]]</span>
                        <span class$="[[_getClassFor('documentType')]]">[[_getAttachmentType(item)]]</span>
                        <div class$="[[_getClassFor('document')]]">
                            <iron-icon icon="icons:attachment"
                                        class="download-icon">
                            </iron-icon>
                            <a href$="[[item.file]]" 
                                class="truncate" 
                                target="_blank">[[item.filename]]
                            </a>
                            <paper-tooltip offset="0">[[item.filename]]</paper-tooltip>

                        </div>
                        <span class="delete-icon" hidden$="[[isTabReadonly(basePermissionPath)]]">
                            <paper-icon-button icon="icons:create" class="edit-icon" on-tap="openEditDialog"></paper-icon-button>
    
                            <paper-icon-button icon="icons:delete" class="edit-icon" on-tap="openDeleteDialog"></paper-icon-button>
                        </span>
                        <span>FAM</span>
                    </div>
                </simple-list-item>
            </template>
            
            <template is="dom-if" if="[[!isReportTab]]">
                <template is="dom-repeat" items="[[linkedAttachments]]" as="linkedAttachment">
                    <simple-list-item>
                        <div class="row-data">
                            <span class$="[[_getClassFor('date')]]">[[prettyDate(linkedAttachment.created)]]</span>
                            <span class$="[[_getClassFor('documentType')]]">[[linkedAttachment.file_type]]</span>
                            <div class$="[[_getClassFor('document')]]">
                                <iron-icon icon="icons:attachment" class="download-icon">
                                </iron-icon>
                                <a href$="[[linkedAttachment.url]]"
                                    class="truncate"
                                    target="_blank">[[linkedAttachment.filename]]
                                </a>
                                <paper-tooltip offset="0">[[linkedAttachment.filename]]</paper-tooltip>
                
                            </div>
                            <a on-click="_openDeleteLinkDialog"
                                class="delete-icon">
                                <iron-icon 
                                    hidden$="[[isTabReadonly(basePermissionPath)]]"
                                    icon="icons:cancel"></iron-icon>
    
                                <paper-tooltip offset="0">Remove</paper-tooltip>
                            </a>
                            <span>PMP</span>
                        </div>
                    </simple-list-item>
                </template>
            </template>

            <template is="dom-if" if="[[!dataItems.length]]">
                <list-element
                        class="list-element"
                        no-additional
                        data="[[emptyObj]]"
                        headings="[[headings]]">
                </list-element>
            </template>
        </etools-content-panel>

        <dialog-element
                opened="{{dialogOpened}}"
                delete-dialog="[[deleteDialog]]"
                dialog-title="[[dialogTitle]]"
                confirm-btn-text="[[confirmBtnText]]"
                request-in-process="[[requestInProcess]]">

            <div class="row-h repeatable-item-container" without-line>
                <div class="repeatable-item-content">
                    <template is="dom-if" if="[[showFileTypes(basePermissionPath)]]">
                        <div class="row-h group">
                            <div class="input-container input-container-ms">
                                <etools-searchable-multiselection-menu
                                        id="fileType"
                                        class$="validate-input disabled-as-readonly [[_setRequired('file_type', basePermissionPath)]]"
                                        value="{{editedItem.type}}"
                                        label="[[getLabel('file_type', basePermissionPath)]]"
                                        placeholder="[[getPlaceholderText('file_type', basePermissionPath)]]"
                                        options="[[fileTypes]]"
                                        custom-object-options
                                        option-label="display_name"
                                        option-value="value"
                                        required$="[[_setRequired('file_type', basePermissionPath)]]"
                                        disabled$="[[requestInProcess]]"
                                        readonly$="[[requestInProcess]]"
                                        invalid="{{errors.file_type}}"
                                        error-message="{{errors.file_type}}"
                                        on-focus="_resetFieldError"
                                        on-tap="_resetFieldError"
                                        hide-search
                                        no-title-attr>
                                </etools-searchable-multiselection-menu>
                            </div>
                        </div>
                    </template>

                    <div class="row-h group">
                        <div class="input-container input-container-ms">
                            <template is="dom-if" if="[[!editedItem.filename]]">
                                <!-- File Upload -->
                                <paper-input-container
                                        class="validate-input"
                                        always-float-label
                                        disabled$="[[requestInProcess]]"
                                        readonly$="[[requestInProcess]]"
                                        invalid="{{errors.file}}">
                                    <label aria-hidden="true" for="uploadButton">[[uploadLabel]]</label>

                                    <paper-button id="uploadButton" class="upload-button" on-tap="_openFileChooser">
                                        <iron-icon icon="file-upload"></iron-icon>
                                        [[uploadLabel]]
                                    </paper-button>

                                    <template is="dom-if" if="[[errors.file]]">
                                        <paper-input-error aria-live="assertive">[[errors.file]]</paper-input-error>
                                    </template>

                                    <input id="fileInput"
                                           class="validate-input"
                                           type="file"
                                           hidden
                                           required
                                           disabled$="[[requestInProcess]]"
                                           readonly$="[[requestInProcess]]"
                                           on-change="_fileSelected">
                                </paper-input-container>
                            </template>

                            <template is="dom-if" if="[[editedItem.filename]]">
                                <paper-input
                                        class="disabled-as-readonly validate-input"
                                        value="{{editedItem.filename}}"
                                        label="[[uploadLabel]]"
                                        required
                                        disabled$="[[requestInProcess]]"
                                        readonly
                                        invalid="{{_checkInvalid(errors.file)}}"
                                        error-message="{{errors.file}}"
                                        on-tap="_openFileChooser">
                                    <iron-icon prefix icon="icons:attachment"></iron-icon>
                                </paper-input>
                            </template>
                        </div>
                    </div>
                </div>
            </div>
        </dialog-element>

        <dialog-element id="deleteLinks" 
            opened="{{deleteLinkOpened}}"
            dialog-name="[[linkToDeleteId]]"
            dialog-title="Are you sure you want to delete?"
            delete-dialog
            on-delete-confirmed="_removeLink"
            confirm-btn-text="Delete"
            cancel-btn-text="Cancel"
        >
        </dialog-element>

        <dialog-element opened="{{shareDialogOpened}}"
                        dialog-title="Share Documents"
                        no-title-margin
                        dialog-name="share-documents"
                        confirm-btn-text="Share"
                        on-dialog-confirmed="_SendShareRequest"
                        confirm-disabled="{{confirmDisabled}}"
                        request-in-process="{{requestInProcess}}">
            <share-documents 
                id="shareDocuments"
                data-base-path="[[dataBasePath]]"
                base-permission-path="[[basePermissionPath]]"
                partner-name= "[[engagement.partner.name]]"
                share-params="{{shareParams}}"
                confirm-disabled="{{confirmDisabled}}"
                >
            </share-documents>
        </dialog-element>
    </template>

    <!-- inject scripts './file-attachments-tab.js'-->
</dom-module>
